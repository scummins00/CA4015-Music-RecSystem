
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CA4015 Music Recommender System</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-2 bd-sidebar site-navigation show single-page" id="site-navigation">
    
</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            
            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/executablebooks/jupyter-book"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Fintro.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-Preliminary_Data_Analysis">
   Preliminary Data Analysis
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-Matrix_Factorization">
   Collaborative Filtering - Matrix Factorization
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#collaborative-filtering-model">
   Collaborative Filtering Model
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-Deep_Learning_Recommender_System">
   Deep Neural Network Recommender System
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-Advanced_Deep_Learning_Recommender_System">
   Advanced Deep Learning Recommender System
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-conclusions">
   Conclusions
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-bibliography">
   Bibliography
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="introduction">
<h1>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h1>
<p>Computer-based systems provide us with the opportunity of mining user history to reveal trends and personal preferences that they, and those around them, may not have previously realised <span id="id1">[<a class="reference internal" href="intro.html#id2">Ekstrand <em>et al.</em>, 2011</a>]</span>. A vast amount of research has been conducted on how to best recommend content to users and many methods have been proposed <span id="id2">[<a class="reference internal" href="intro.html#id4">Balabanović and Shoham, 1997</a>, <a class="reference internal" href="intro.html#id6">Guttman <em>et al.</em>, 1998</a>, <a class="reference internal" href="intro.html#id5">Pazzani, 1999</a>]</span>.</p>
<p>In this research, we will be focusing on Collaborative Filtering <span id="id3">[<a class="reference internal" href="intro.html#id8">Su and Khoshgoftaar, 2009</a>, <a class="reference internal" href="intro.html#id7">Thorat <em>et al.</em>, 2015</a>]</span>, an approach that decides what to recommend to a user based on the preferences of similar users <span id="id4">[<a class="reference internal" href="intro.html#id9">Elahi <em>et al.</em>, 2016</a>, <a class="reference internal" href="intro.html#id8">Su and Khoshgoftaar, 2009</a>]</span>. Similarity between users is estimated by comparing user-interactions and ratings with products or services <span id="id5">[<a class="reference internal" href="intro.html#id9">Elahi <em>et al.</em>, 2016</a>, <a class="reference internal" href="intro.html#id7">Thorat <em>et al.</em>, 2015</a>]</span>. The table below highlights some popular services currently using recommender systems.</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="text-align:center head"><p>Service</p></th>
<th class="text-align:center head"><p>Recommendations</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:center"><p>Amazon</p></td>
<td class="text-align:center"><p>Retail Products</p></td>
</tr>
<tr class="row-odd"><td class="text-align:center"><p>Facebook (Meta)</p></td>
<td class="text-align:center"><p>Friends</p></td>
</tr>
<tr class="row-even"><td class="text-align:center"><p>Netflix</p></td>
<td class="text-align:center"><p>Movies / Shows</p></td>
</tr>
<tr class="row-odd"><td class="text-align:center"><p>Spotify</p></td>
<td class="text-align:center"><p>Music</p></td>
</tr>
<tr class="row-even"><td class="text-align:center"><p>Youtube</p></td>
<td class="text-align:center"><p>Videos</p></td>
</tr>
<tr class="row-odd"><td class="text-align:center"><p>Google News</p></td>
<td class="text-align:center"><p>News</p></td>
</tr>
</tbody>
</table>
<p>Recommending something to someone else is a natural process that aims to help somebody sift through a large corpus of information efficiently to find only the items of most interest to them. Recommender systems augment that process, and as such have become a vital tool for information-availability in our increasingly digital lives <span id="id6">[<a class="reference internal" href="intro.html#id8">Su and Khoshgoftaar, 2009</a>]</span>.</p>
<p>In the following Jupyter Book, we will be using data acquired from the <a class="reference external" href="https://grouplens.org/datasets/hetrec-2011/">HETREC 2011</a><span id="id7">[<a class="reference internal" href="intro.html#id3">Cantador <em>et al.</em>, 2011</a>]</span> 2nd International Workshop on Information Heterogeneity and Fusion in Recommender Systems. In particular, we will be focusing on the <em>artist listening records</em> dataset published by <a class="reference external" href="https://www.last.fm/">Last.FM</a>. This dataset consists of 92,800 artists listening records from 1,892 users. We will explore this data in more detail in <a class="reference internal" href="intro.html#document-Preliminary_Data_Analysis"><span class="doc">Preliminary Data Analysis</span></a>. In the following section, we will discuss in-depth two approaches to Collaborative Filtering, namely; <em>Matrix Factorisation</em>, and <em>Recommendation with Deep Neural Networks</em>.</p>
</div>
<div class="section" id="collaborative-filtering">
<h1>Collaborative Filtering<a class="headerlink" href="#collaborative-filtering" title="Permalink to this headline">¶</a></h1>
<p>Collaborative Filtering (CF) was a term first coined by the makers of <em>Tapestry</em>, the first recommender system.
CF aims to solve the problem of recommending <span class="math notranslate nohighlight">\(m\)</span> items, by <span class="math notranslate nohighlight">\(n\)</span> users where the data is often represented by a <span class="math notranslate nohighlight">\(n \times m\)</span> matrix <span id="id8">[<a class="reference internal" href="intro.html#id10">Laishram <em>et al.</em>, 2016</a>]</span>. There are two main approaches to CF, <em>neighborhood methods</em>, and <em>latent factor models</em>. The neighborhood methods compute the relationships between users, or alternatively items. Latent Factor models aim to characetrize users and items on many abstract factors infered from the rating patterns. The most successful realisations of latent factor models are based on <em>matrix facotrisation</em> (MF). <span id="id9">[<a class="reference internal" href="intro.html#id11">Koren <em>et al.</em>, 2009</a>]</span>. In this section, we will look at MF more closely, focusing on the aspects we will incorporate during our research.</p>
<div class="section" id="matrix-factorisation-mf">
<h2>Matrix Factorisation (MF)<a class="headerlink" href="#matrix-factorisation-mf" title="Permalink to this headline">¶</a></h2>
<p>In its basic form, MF characterises querys (users) and items by vectors which are inferred from rating patterns. High correspondance between query vector and item vector results in a recommendation. The most useful data from an MF model is <em>explicit</em> feedback. This constitutes explicit input from users regarding interest in items. We refer to this as <em>rating</em> <span id="id10">[<a class="reference internal" href="intro.html#id11">Koren <em>et al.</em>, 2009</a>]</span>. The construction of query and item vectors intends to model user preferences as shown in the figure below.</p>
<a class="bg-primary mb-1 reference internal image-reference" href="_images/mf_latent_factors.png"><img alt="latent_factor_diagram" class="bg-primary mb-1 align-center" src="_images/mf_latent_factors.png" style="width: 40%;" /></a>
<p>As stated previously, in MF, we are given the feedback matrix denoted <span class="math notranslate nohighlight">\(A \in \mathbb{R}^{m \times n}\)</span>, where <span class="math notranslate nohighlight">\(m\)</span> is the number of queries and <span class="math notranslate nohighlight">\(n\)</span> is the number of items. We will denote our user vector <span class="math notranslate nohighlight">\(U \in \mathbb{R}^{m \times d}\)</span>, and our item vector <span class="math notranslate nohighlight">\(V \in \mathbb{R}^{n \times d}\)</span>. We will use the product <span class="math notranslate nohighlight">\(UV^{T}\)</span> as our approximation of <span class="math notranslate nohighlight">\(A\)</span>.</p>
<p>Our objective function is then defined as follows:
$<span class="math notranslate nohighlight">\(
    \min _{U \in \mathbb{R}^{m \times d}, V \in \mathbb{R}^{n \times d}}\sum_{(i,j) \in obs} (A_{ij} - \langle U_{i},V_{j} \rangle)^{2}
\)</span>$</p>
<p>The two standard approaches to minimizing error in CF are <em>Alternating Least Squares</em> (ALS) <span id="id11">[<a class="reference internal" href="intro.html#id12">Cichocki and Zdunek, 2007</a>]</span>, and <em>Stochaistic Gradient Descent</em> (SGD) <span id="id12">[<a class="reference internal" href="intro.html#id13">Gemulla <em>et al.</em>, 2011</a>]</span>. <em>Weighted Alternating Least Squares</em> (WALS) is a modified version of ALS that is suited to MF. In the literature, it is often cited that WALS is the prefered algorithm for recommender systems. This is because WALS is optimised for parallelization, meaning it is scalable to large scale data. As well as this, ALS performs better than SGD on systems centered on implicit data <span id="id13">[<a class="reference internal" href="intro.html#id11">Koren <em>et al.</em>, 2009</a>]</span>. SGD cannot directly scale to very large data <span id="id14">[<a class="reference internal" href="intro.html#id13">Gemulla <em>et al.</em>, 2011</a>]</span>. Taking our own problem into consideration, either approach is suitable. The recognised benefits of WALS are not of interest to us as parallelization is out of the scope for this research. We have no information regarding intrinsic user data such as age, country, etc. Our dataset is also small enough that the performance of SGD is not severly hindered. Therefore, we will adopt SGD in this approach.</p>
</div>
<div class="section" id="deep-neural-networks">
<h2>Deep Neural Networks<a class="headerlink" href="#deep-neural-networks" title="Permalink to this headline">¶</a></h2>
<p>Advances in deep learning-based recommender systems have gained notable traction over the past years. This goes hand-in-hand with the increased adoption of deep learning frameworks in most ML applications. Deep learning can effectively capture nonlinear and nontrivial user-item relationships through complex data abstraction <span id="id15">[<a class="reference internal" href="intro.html#id18">Zhang <em>et al.</em>, 2019</a>]</span>.</p>
<p>To develop our own deep neural network recommender, we will employ Tensorflow V2, with an emphasis on the <a class="reference external" href="https://www.tensorflow.org/recommenders/api_docs/python/tfrs"><em>Tensorflow Recommedation Systems</em></a> (TFRS) package. Tensorflow is developed by Google, the leading experts in recommendation systems. The TFRS package can be used through Keras which is an API built atop Tensorflow. TFRS provides a large volume functions designed spcifically for working with recommender systems.</p>
<p>Google have also authored many publications regarding their philosophy regarding recommender systems for their various applications <span id="id16">[<a class="reference internal" href="intro.html#id17">Cheng <em>et al.</em>, 2016</a>, <a class="reference internal" href="intro.html#id16">Covington <em>et al.</em>, 2016</a>]</span>. They regularly follow a repeating pattern of developing two seperate ‘Towers’, a user (query) tower, and an item (candidate) tower. Each of these towers can have varying levels of complexity, and can host deep learning embedings. A combined model of the outputs of these seperate towers is then designed as a feed-forward deep network.</p>
<p>Google also regularly advice a two-tier approach to recommender systems. That is: a retrieval model, and a ranking model. Their typical architeture is displayed in the image below, which has been abstracted from <span id="id17">[<a class="reference internal" href="intro.html#id17">Cheng <em>et al.</em>, 2016</a>]</span></p>
<a class="bg-primary mb-1 reference internal image-reference" href="_images/google_architecture.png"><img alt="google_achitecture" class="bg-primary mb-1 align-center" src="_images/google_architecture.png" style="width: 40%;" /></a>
<p>The TFRS package allows for the easy creation of recommender models by following simple steps. Firstly, one must inheret from the base <code class="docutils literal notranslate"><span class="pre">tfrs.Model</span></code> class, which is packaged with many utility functions. We build our objective function (<em>denoted as the task</em>) on top of this class. Using different objective functions is simply a case of swapping out a single line of code. In our examples, we will make use of the <em>Adaptive Gradient Algorithm</em> (Adagrad), which is an SGD optimiser. It works by maintaining low learning rates (usually denoted <span class="math notranslate nohighlight">\(\alpha \)</span>) for frequently occuring features, and high learning rates for less frequent features. Where we can, we will use <em>Root Mean Squared Error</em> (RMSE) as our metric for model comparison.</p>
</div>
<div class="toctree-wrapper compound">
<span id="document-Preliminary_Data_Analysis"></span><div class="section" id="preliminary-data-analysis">
<h2>Preliminary Data Analysis<a class="headerlink" href="#preliminary-data-analysis" title="Permalink to this headline">¶</a></h2>
<div class="section" id="objective">
<h3>Objective<a class="headerlink" href="#objective" title="Permalink to this headline">¶</a></h3>
<p>The following notebook aims to perform some preliminary data analysis on the <a class="reference external" href="http://last.fm">last.fm</a> dataset used at HetRec2011 which can be found <a class="reference external" href="https://grouplens.org/datasets/hetrec-2011/">Here</a>. We aim to perform the following analysis:</p>
<ul class="simple">
<li><p><strong>Missing Values</strong></p>
<ul>
<li><p>Test for the occurence of missing values across our data</p></li>
<li><p>Understand the impact of missing values on our analysis</p></li>
</ul>
</li>
<li><p><strong>Data Distribution</strong></p>
<ul>
<li><p>Is a particular genre over or under represented?</p></li>
<li><p>With respect to users-artists, what is the distribution of ‘number of listens’?</p></li>
</ul>
</li>
</ul>
<p>As well as these defined objectives, this notebook intends to explore our data, and develop a sense for the nature of the information and how disparate data sources relate to one another.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Let&#39;s view the user-artist data first</span>
<span class="n">user_artist</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/user_artists.dat&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
<span class="n">user_artist</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>userID</th>
      <th>artistID</th>
      <th>weight</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2</td>
      <td>51</td>
      <td>13883</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>52</td>
      <td>11690</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>53</td>
      <td>11351</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2</td>
      <td>54</td>
      <td>10300</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2</td>
      <td>55</td>
      <td>8983</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="missing-values">
<h3>Missing Values<a class="headerlink" href="#missing-values" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Test for the occurence of missing values</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;../data/&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">file</span> <span class="o">!=</span> <span class="s1">&#39;readme.txt&#39;</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;../data/</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reading file: </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s1"> | Contains missing data: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Reading file: artists.dat | Contains missing data: True
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">PermissionError</span><span class="g g-Whitespace">                           </span>Traceback (most recent call last)
<span class="o">~</span>\<span class="n">AppData</span>\<span class="n">Local</span>\<span class="n">Temp</span><span class="o">/</span><span class="n">ipykernel_6512</span><span class="o">/</span><span class="mf">1821401783.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;../data/&#39;</span><span class="p">):</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="k">if</span> <span class="n">file</span> <span class="o">!=</span> <span class="s1">&#39;readme.txt&#39;</span><span class="p">:</span>
<span class="ne">----&gt; </span><span class="mi">5</span>         <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;../data/</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>         <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reading file: </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s1"> | Contains missing data: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="nn">~\AppData\Roaming\Python\Python38\site-packages\pandas\io\parsers.py</span> in <span class="ni">parser_f</span><span class="nt">(filepath_or_buffer, sep, delimiter, header, names, index_col, usecols, squeeze, prefix, mangle_dupe_cols, dtype, engine, converters, true_values, false_values, skipinitialspace, skiprows, skipfooter, nrows, na_values, keep_default_na, na_filter, verbose, skip_blank_lines, parse_dates, infer_datetime_format, keep_date_col, date_parser, dayfirst, cache_dates, iterator, chunksize, compression, thousands, decimal, lineterminator, quotechar, quoting, doublequote, escapechar, comment, encoding, dialect, error_bad_lines, warn_bad_lines, delim_whitespace, low_memory, memory_map, float_precision)</span>
<span class="g g-Whitespace">    </span><span class="mi">674</span>         <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">675</span> 
<span class="ne">--&gt; </span><span class="mi">676</span>         <span class="k">return</span> <span class="n">_read</span><span class="p">(</span><span class="n">filepath_or_buffer</span><span class="p">,</span> <span class="n">kwds</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">677</span> 
<span class="g g-Whitespace">    </span><span class="mi">678</span>     <span class="n">parser_f</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">name</span>

<span class="nn">~\AppData\Roaming\Python\Python38\site-packages\pandas\io\parsers.py</span> in <span class="ni">_read</span><span class="nt">(filepath_or_buffer, kwds)</span>
<span class="g g-Whitespace">    </span><span class="mi">446</span> 
<span class="g g-Whitespace">    </span><span class="mi">447</span>     <span class="c1"># Create the parser.</span>
<span class="ne">--&gt; </span><span class="mi">448</span>     <span class="n">parser</span> <span class="o">=</span> <span class="n">TextFileReader</span><span class="p">(</span><span class="n">fp_or_buf</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">449</span> 
<span class="g g-Whitespace">    </span><span class="mi">450</span>     <span class="k">if</span> <span class="n">chunksize</span> <span class="ow">or</span> <span class="n">iterator</span><span class="p">:</span>

<span class="nn">~\AppData\Roaming\Python\Python38\site-packages\pandas\io\parsers.py</span> in <span class="ni">__init__</span><span class="nt">(self, f, engine, **kwds)</span>
<span class="g g-Whitespace">    </span><span class="mi">878</span>             <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;has_index_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwds</span><span class="p">[</span><span class="s2">&quot;has_index_names&quot;</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">879</span> 
<span class="ne">--&gt; </span><span class="mi">880</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_make_engine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">881</span> 
<span class="g g-Whitespace">    </span><span class="mi">882</span>     <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="nn">~\AppData\Roaming\Python\Python38\site-packages\pandas\io\parsers.py</span> in <span class="ni">_make_engine</span><span class="nt">(self, engine)</span>
<span class="g g-Whitespace">   </span><span class="mi">1112</span>     <span class="k">def</span> <span class="nf">_make_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1113</span>         <span class="k">if</span> <span class="n">engine</span> <span class="o">==</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1114</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="n">CParserWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1115</span>         <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1116</span>             <span class="k">if</span> <span class="n">engine</span> <span class="o">==</span> <span class="s2">&quot;python&quot;</span><span class="p">:</span>

<span class="nn">~\AppData\Roaming\Python\Python38\site-packages\pandas\io\parsers.py</span> in <span class="ni">__init__</span><span class="nt">(self, src, **kwds)</span>
<span class="g g-Whitespace">   </span><span class="mi">1872</span>         <span class="k">if</span> <span class="n">kwds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;compression&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">encoding</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1873</span>             <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<span class="ne">-&gt; </span><span class="mi">1874</span>                 <span class="n">src</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1875</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1876</span> 

<span class="ne">PermissionError</span>: [Errno 13] Permission denied: &#39;../data/songs&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Investigating missing data in artists.dat</span>
<span class="n">artists</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/artists.dat&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
<span class="n">artists</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(17632, 4)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Total number of rows in artists with missing values</span>
<span class="n">artists</span><span class="p">[</span><span class="n">artists</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(444, 4)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Columns in artists with missing values</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">artists</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Column: </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1"> | Contains missing data: </span><span class="si">{</span><span class="n">artists</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Column: id | Contains missing data: False
Column: name | Contains missing data: False
Column: url | Contains missing data: False
Column: pictureURL | Contains missing data: True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Let&#39;s check that artist names and ID&#39;s are unique</span>
<span class="nb">print</span><span class="p">(</span><span class="n">artists</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">is_unique</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">artists</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">is_unique</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
True
</pre></div>
</div>
</div>
</div>
<div class="section" id="findings">
<h4>Findings<a class="headerlink" href="#findings" title="Permalink to this headline">¶</a></h4>
<p>The data is very clean with <span class="math notranslate nohighlight">\(5/6\)</span> datasets having no missing values. The artists data does contain missing values, however only in the ‘pictureURL’ column. This column will not be a fundamental part of any analysis. Therefore, there is no impact of missing values on our data.</p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="data-distribution">
<h3>Data Distribution<a class="headerlink" href="#data-distribution" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Let&#39;s investigate how many users we have</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">user_artist</span><span class="o">.</span><span class="n">userID</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>

<span class="c1">#Let&#39;s investigate the number of artists</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">artists</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1892
17632
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s investigate how different genres are represented in our data</span>
<span class="n">tagged_artists</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/user_taggedartists.dat&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
<span class="n">tags</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/tags.dat&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
<span class="n">tagged_artists</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>userID</th>
      <th>artistID</th>
      <th>tagID</th>
      <th>day</th>
      <th>month</th>
      <th>year</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2</td>
      <td>52</td>
      <td>13</td>
      <td>1</td>
      <td>4</td>
      <td>2009</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>52</td>
      <td>15</td>
      <td>1</td>
      <td>4</td>
      <td>2009</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>52</td>
      <td>18</td>
      <td>1</td>
      <td>4</td>
      <td>2009</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2</td>
      <td>52</td>
      <td>21</td>
      <td>1</td>
      <td>4</td>
      <td>2009</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2</td>
      <td>52</td>
      <td>41</td>
      <td>1</td>
      <td>4</td>
      <td>2009</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Let&#39;s count the tags that appear</span>
<span class="n">tag_count</span> <span class="o">=</span> <span class="n">tagged_artists</span><span class="p">[[</span><span class="s1">&#39;tagID&#39;</span><span class="p">,</span> <span class="s1">&#39;artistID&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;tagID&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">tag_count</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;artistID&#39;</span><span class="p">:</span><span class="s1">&#39;count&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">#Find string text values</span>
<span class="n">tag_text</span> <span class="o">=</span> <span class="n">tag_count</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;tagID&#39;</span><span class="p">)</span>

<span class="c1">#Extract top 20 tags</span>
<span class="n">top_20_tags</span> <span class="o">=</span> <span class="n">tag_text</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize the matplotlib figure</span>
<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>

<span class="n">col</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;hls&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;tagValue&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">top_20_tags</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;tagValue&quot;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Most Common Tags&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Tag&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Preliminary_Data_Analysis_14_0.png" src="_images/Preliminary_Data_Analysis_14_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Let&#39;s investigate the distribution of number of total listens by users</span>
<span class="n">listen_per_user</span> <span class="o">=</span> <span class="n">user_artist</span><span class="p">[[</span><span class="s1">&#39;userID&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;userID&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="c1">#Give each user a bin to fit in</span>
<span class="n">listen_per_user</span><span class="p">[</span><span class="s1">&#39;bin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">listen_per_user</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1">#Count how many users per bin</span>
<span class="n">count_per_bin</span> <span class="o">=</span> <span class="n">listen_per_user</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;bin&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Plot the bins</span>
<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>

<span class="n">col</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;Set2&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;bin&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">count_per_bin</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;User Listening Categories&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Total Listening Count (Bins)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Number of Users&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Preliminary_Data_Analysis_16_0.png" src="_images/Preliminary_Data_Analysis_16_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Same graph but as a conventional histogram</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">listening_habits</span> <span class="o">=</span> <span class="n">user_artist</span><span class="p">[[</span><span class="s1">&#39;userID&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;userID&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">listening_habits</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;User Listening Habits&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Music Listen Count&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Number of Users&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Preliminary_Data_Analysis_17_0.png" src="_images/Preliminary_Data_Analysis_17_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># What portion of users are contained within the first bins</span>
<span class="n">bin_1</span> <span class="o">=</span> <span class="n">count_per_bin</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">bin_2</span> <span class="o">=</span> <span class="n">count_per_bin</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">bin_3</span> <span class="o">=</span> <span class="n">count_per_bin</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">total_pop</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_artist</span><span class="o">.</span><span class="n">userID</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Users in largest bin: </span><span class="si">{</span><span class="n">bin_1</span><span class="si">}</span><span class="s1"> | Portion of total: </span><span class="si">{</span><span class="p">(</span><span class="n">bin_1</span><span class="o">/</span><span class="n">total_pop</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Users in second largest bin: </span><span class="si">{</span><span class="n">bin_2</span><span class="si">}</span><span class="s1"> | Portion of total: </span><span class="si">{</span><span class="p">(</span><span class="n">bin_2</span><span class="o">/</span><span class="n">total_pop</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Users in third largest bin: </span><span class="si">{</span><span class="n">bin_3</span><span class="si">}</span><span class="s1"> | Portion of total: </span><span class="si">{</span><span class="p">(</span><span class="n">bin_3</span><span class="o">/</span><span class="n">total_pop</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The mean of user listening habits: </span><span class="si">{</span><span class="n">listening_habits</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Users in largest bin: 1022 | Portion of total: 54.02%
Users in second largest bin: 466 | Portion of total: 24.63%
Users in third largest bin: 171 | Portion of total: 9.04%
The mean of user listening habits: 36566.58
</pre></div>
</div>
</div>
</div>
<div class="section" id="id1">
<h4>Findings<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>As this dataset was used in 2011, the general music trends are those observed for that period. These musical trends differ substantially from the music we listen to today. Therefore, recommender systems build ontop of this data will produce recommendations biased towards that time period. This is not an error, rather just a property of the data.</p>
<p>We see that <strong>rock</strong> features heavily in the top 20 tags found throughout the data, arising in many forms from metal and hard, to classic and indie. In terms of users listening habits, we observe that the vaste majority of users (<strong>54%</strong>) have listened to songs 24,000 or less times. By the third bin, a cummulative <strong>87%</strong> of users have listened to music 72,000 times or less. The majority of the final bins contain extraim outliers such as users who have listened to music over 480,000 times.</p>
<p>I did expect user listening habits to follow more of a normal distribution, and was surprised to find the distribution follows a curve more closely related to exponential decay. The distribution is skewed to the right and decreases sharply. The mean is 36,566 listens.</p>
</div>
</div>
<div class="section" id="conclusions">
<h3>Conclusions<a class="headerlink" href="#conclusions" title="Permalink to this headline">¶</a></h3>
<p>The usability of this data is quite high, therefore requiring only a short preliminary analysis. The data is clean and structured, featuring missing values only for unimportant features like ‘pictureURL’. There are no duplicate artists featured in the data.</p>
<p>An analysis of the user listening habits allows us to better understand the distribution of the data we are using. Investigation of the most popular tags used to describe music in this dataset helped us understand trends which are representative of the time period in which the data was released. With this knowledge, we will better understand the output of the recommender system we are developing later on.</p>
</div>
</div>
<span id="document-Matrix_Factorization"></span><div class="section" id="collaborative-filtering-matrix-factorization">
<h2>Collaborative Filtering - Matrix Factorization<a class="headerlink" href="#collaborative-filtering-matrix-factorization" title="Permalink to this headline">¶</a></h2>
<p>In this Notebook, we will be performing collaborative filtering using matrix factorization. The steps we will follow are detailed in the introduction. We will be using TensorFlow as our ML framework for the development of our music recommender system. Let’s begin by importing our packages, and building a sparse representation of our ratings matrix.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow.compat.v1</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.mplot3d</span> <span class="kn">import</span> <span class="n">Axes3D</span>
<span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">display</span>
<span class="kn">import</span> <span class="nn">sklearn</span>
<span class="kn">import</span> <span class="nn">sklearn.manifold</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">disable_eager_execution</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We are importing a range of helper functions in the below cell. These functions are defined in <code class="docutils literal notranslate"><span class="pre">CFUtils.py</span></code>, and <code class="docutils literal notranslate"><span class="pre">CFModel.py</span></code>, both of which can be found in the <a class="reference external" href="https://github.com/scummins00/CA4015-Music-RecSystem">Github Repository</a> for this assignment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Let&#39;s import our helper functions defined externally</span>
<span class="kn">from</span> <span class="nn">CFUtils</span> <span class="kn">import</span> <span class="n">build_rating_sparse_tensor</span><span class="p">,</span> <span class="n">split_dataframe</span><span class="p">,</span> <span class="n">sparse_mean_square_error</span><span class="p">,</span> <span class="n">build_model</span><span class="p">,</span> <span class="n">item_neighbors</span><span class="p">,</span> <span class="n">user_recommendations</span>
<span class="kn">from</span> <span class="nn">CFModel</span> <span class="kn">import</span> <span class="n">CFModel</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add some convenience functions to Pandas DataFrame.</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_rows</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
<span class="k">def</span> <span class="nf">mask</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">function</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a filtered dataframe, by applying function to key&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">function</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">key</span><span class="p">])]</span>

<span class="k">def</span> <span class="nf">flatten_cols</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">flatten_cols</span> <span class="o">=</span> <span class="n">flatten_cols</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="feature-engineering">
<h3>Feature Engineering<a class="headerlink" href="#feature-engineering" title="Permalink to this headline">¶</a></h3>
<p>In the following cells, we will be re-mapping our user ID’s to fit into a scale that is defined as <span class="math notranslate nohighlight">\([0, m]\)</span>, where <span class="math notranslate nohighlight">\(m\)</span> is our number of unique users. Currently, despite there being only 1,892 unique users, profiles exist with ID’s such as 1,893, 2,000, and so on. This is an issue because when we generate our ratings matrix, we will be creating rows that do not represent any users. Mapping our user ID’s to a suitable scale is good practice and will avoid issues in the future.</p>
<p>The case is the same for artist ID’s with them not being presented in a contiguous order. We will apply the same principal above to remap our artist ID’s to the correct scale.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Let&#39;s define our amount of users</span>
<span class="n">rating_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/user_artists.dat&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
<span class="n">num_users</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rating_matrix</span><span class="o">.</span><span class="n">userID</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="c1">#Extract userID column</span>
<span class="n">userids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rating_matrix</span><span class="o">.</span><span class="n">userID</span><span class="p">)</span>

<span class="c1">#Remap the column</span>
<span class="n">u_mapper</span><span class="p">,</span> <span class="n">u_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">userids</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Let&#39;s define our amount of artists</span>
<span class="n">artists</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/artists.dat&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
<span class="n">artists</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="s1">&#39;artistID&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">num_artists</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">artists</span><span class="o">.</span><span class="n">artistID</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="c1">#Extract artistID column</span>
<span class="n">artistids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rating_matrix</span><span class="o">.</span><span class="n">artistID</span><span class="p">)</span>

<span class="c1">#Remap the column</span>
<span class="n">a_mapper</span><span class="p">,</span> <span class="n">a_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">artistids</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Assert that u_ind and userID column are of same size</span>
<span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">u_ind</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">rating_matrix</span><span class="o">.</span><span class="n">userID</span><span class="p">))</span>

<span class="c1">#Assert that a_ind and artistID column are of same size</span>
<span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a_ind</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">rating_matrix</span><span class="o">.</span><span class="n">artistID</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s replace old columns with new ind ones</span>
<span class="n">rating_matrix</span><span class="o">.</span><span class="n">userID</span> <span class="o">=</span> <span class="n">u_ind</span>
<span class="n">rating_matrix</span><span class="o">.</span><span class="n">artistID</span> <span class="o">=</span> <span class="n">a_ind</span>

<span class="c1">#Let&#39;s ensure the max value is approriate</span>
<span class="k">assert</span><span class="p">(</span><span class="n">rating_matrix</span><span class="o">.</span><span class="n">userID</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1891</span><span class="p">)</span>
<span class="k">assert</span><span class="p">(</span><span class="n">rating_matrix</span><span class="o">.</span><span class="n">artistID</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">17631</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="the-problem-with-rating-values">
<h3>The Problem With Rating Values<a class="headerlink" href="#the-problem-with-rating-values" title="Permalink to this headline">¶</a></h3>
<p>For this collaborative filtering model, I would have liked to make use of the explicit rating data available in the ‘weight’ column of the ratings matrix. Through trial and error, I’ve come to the conclusion that using this data explicitly will not create an effective recommendation system.</p>
<p>The reason for this is to do with the the distribution of user to artist listens. Many user to artist combinations have only a value of 1 for the ‘weight’ column. When aggregating the total listens for artists by summing the weights, we see a huge portion of the artists still only have 1 or so listens, whilst popular artists such as Katy Perry, Lady Gaga, and Britney Spears, can accumulate millions of listens, Britney Spears coming out on top with 2.4 million listens from users in this dataset. This problem is known as the <em>Long Tail Problem</em> <span id="id1">[<a class="reference internal" href="intro.html#id15">Anderson, 2006</a>]</span>.</p>
<p>Intuitively, this is not suitable for a recommendation system because in this case if we ignore the outliers, we are ignoring the most important features of the dataset. Normalising our ‘weight’ column has little-to-no effect on performance as squashing such disparate values into a smaller range does not fix the disparity.</p>
<p>Another approach is to use a binary representation of the ratings matrix. If a user has ever listened to an artist, the ‘listened’ column receives a value of 1. Otherwise, the value is 0. This approach does result in some information loss, as we are no longer aware of how regular of a listener a user is to a particular artist.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#We&#39;re going to make a binary representation of the matrix. If the user ever listened to the artist, they get a value of 1. 0 otherwise</span>
<span class="n">rating_matrix</span><span class="p">[</span><span class="s1">&#39;listened&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rating_matrix</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>userID</th>
      <th>artistID</th>
      <th>weight</th>
      <th>listened</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>92834.000</td>
      <td>92834.000</td>
      <td>92834.000</td>
      <td>92834.000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>944.222</td>
      <td>3235.737</td>
      <td>745.244</td>
      <td>1.000</td>
    </tr>
    <tr>
      <th>std</th>
      <td>546.751</td>
      <td>4197.217</td>
      <td>3751.322</td>
      <td>0.000</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000</td>
      <td>0.000</td>
      <td>1.000</td>
      <td>1.000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>470.000</td>
      <td>430.000</td>
      <td>107.000</td>
      <td>1.000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>944.000</td>
      <td>1237.000</td>
      <td>260.000</td>
      <td>1.000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>1416.000</td>
      <td>4266.000</td>
      <td>614.000</td>
      <td>1.000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>1891.000</td>
      <td>17631.000</td>
      <td>352698.000</td>
      <td>1.000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="section" id="adding-genres-to-artists">
<h4>Adding Genres to Artists<a class="headerlink" href="#adding-genres-to-artists" title="Permalink to this headline">¶</a></h4>
<p>For visualisating our recommendations, we will view the dispersion of genres in latent space. This will allow us to understand if music of similar genres generally cluster around each other. For this, we would like to be able to join our artists and genres tables.</p>
<p>We must firstly merge the <code class="docutils literal notranslate"><span class="pre">tags.dat</span></code> data with the <code class="docutils literal notranslate"><span class="pre">user_taggedartists.dat</span></code> data. We then <code class="docutils literal notranslate"><span class="pre">groupby</span></code> artist name and use a lambda function to list the genres for that artist. It should be noted that <code class="docutils literal notranslate"><span class="pre">user_taggedartists.dat</span></code> is user-generated information, and therefore may contain some innacurate or unimportant artist tags. To counteract this, we will only be including a tag as part of the artists genre if it has been associated with that artist on 3 or more seperate occasions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Let&#39;s read in genres and tags</span>
<span class="n">genres</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/tags.dat&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
<span class="n">artists_tagged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/user_taggedartists.dat&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Let&#39;s match artists to genres</span>
<span class="n">artists_tagged</span> <span class="o">=</span> <span class="n">artists_tagged</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">genres</span><span class="p">[[</span><span class="s1">&#39;tagID&#39;</span><span class="p">,</span> <span class="s1">&#39;tagValue&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;tagID&#39;</span><span class="p">)</span>
<span class="n">artists_tagged</span> <span class="o">=</span> <span class="p">(</span><span class="n">artists_tagged</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;artistID&#39;</span><span class="p">)[</span><span class="s1">&#39;tagValue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">grp</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">grp</span><span class="p">)))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We know that as tags are applied by users, they can be innaccurate and messy. In the following cell we perform these actions:</p>
<ol class="simple">
<li><p>Loop through each artist in our <code class="docutils literal notranslate"><span class="pre">artists_tagged</span></code> table</p></li>
<li><p>Create a dictionary for that artist’s tags</p></li>
<li><p>Count the tags using the dictionary</p></li>
<li><p>Order the artist tags by number of appearances and save them in a <code class="docutils literal notranslate"><span class="pre">new_tags</span></code> variable.</p></li>
<li><p>The artist receives the <code class="docutils literal notranslate"><span class="pre">new_tags</span></code> variable (“No Tags” string if list is empty.)</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">artists_tagged</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">new_tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">tagValue</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">&gt;=</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">new_tags</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">])</span>
    <span class="n">new_tags</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">new_tags</span><span class="p">:</span>
        <span class="n">artists_tagged</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;tagValue&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">new_tags</span><span class="p">]</span>
        <span class="n">artists_tagged</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;genre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">artists_tagged</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;tagValue&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Let&#39;s add these tags to our artists</span>
<span class="n">artists</span> <span class="o">=</span> <span class="n">artists</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">artists_tagged</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;artistID&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">rsuffix</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
<span class="n">artists</span><span class="o">.</span><span class="n">tagValue</span> <span class="o">=</span> <span class="n">artists</span><span class="o">.</span><span class="n">tagValue</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;No Tags&#39;</span><span class="p">)</span>
<span class="n">artists</span><span class="o">.</span><span class="n">genre</span> <span class="o">=</span> <span class="n">artists</span><span class="o">.</span><span class="n">genre</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;No Tags&#39;</span><span class="p">)</span>
<span class="n">artists</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;artistIDright&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;pictureURL&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">artists</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;tagValue&#39;</span><span class="p">:</span> <span class="s1">&#39;genres&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">artists</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>artistID</th>
      <th>name</th>
      <th>genres</th>
      <th>genre</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>MALICE MIZER</td>
      <td>[darkwave, german, gothic]</td>
      <td>darkwave</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>Diary of Dreams</td>
      <td>[black metal]</td>
      <td>black metal</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>Carpathian Forest</td>
      <td>[j-rock, japanese, visual kei, gothic]</td>
      <td>j-rock</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>Moi dix Mois</td>
      <td>[darkwave]</td>
      <td>darkwave</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>Bella Morte</td>
      <td>[gothic metal, doom metal, black metal]</td>
      <td>gothic metal</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>17627</th>
      <td>18741</td>
      <td>Diamanda GalÃ¡s</td>
      <td>No Tags</td>
      <td>No Tags</td>
    </tr>
    <tr>
      <th>17628</th>
      <td>18742</td>
      <td>Aya RL</td>
      <td>No Tags</td>
      <td>No Tags</td>
    </tr>
    <tr>
      <th>17629</th>
      <td>18743</td>
      <td>Coptic Rain</td>
      <td>No Tags</td>
      <td>No Tags</td>
    </tr>
    <tr>
      <th>17630</th>
      <td>18744</td>
      <td>Oz Alchemist</td>
      <td>No Tags</td>
      <td>No Tags</td>
    </tr>
    <tr>
      <th>17631</th>
      <td>18745</td>
      <td>Grzegorz Tomczak</td>
      <td>No Tags</td>
      <td>No Tags</td>
    </tr>
  </tbody>
</table>
<p>17632 rows × 4 columns</p>
</div></div></div>
</div>
</div>
<div class="section" id="artist-total-listens-value">
<h4>Artist Total Listens Value<a class="headerlink" href="#artist-total-listens-value" title="Permalink to this headline">¶</a></h4>
<p>Later on we will use an artists total number of listens as part of our visualisations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Let&#39;s groupby artist ID and sum weight for their total listens</span>
<span class="n">artist_tot_listens</span> <span class="o">=</span> <span class="n">rating_matrix</span><span class="p">[[</span><span class="s1">&#39;artistID&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;artistID&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

<span class="c1">#Let&#39;s also add the artist name for clarity</span>
<span class="n">artist_tot_listens</span> <span class="o">=</span> <span class="n">artist_tot_listens</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">artists</span><span class="p">,</span> <span class="n">lsuffix</span><span class="o">=</span><span class="s1">&#39;artistID&#39;</span><span class="p">,</span> <span class="n">rsuffix</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">)[[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="collaborative-filtering-model">
<h2>Collaborative Filtering Model<a class="headerlink" href="#collaborative-filtering-model" title="Permalink to this headline">¶</a></h2>
<p>At this point, we are ready to build a very basic first version of our collaborative filtering model. In the below code, we will be using a modified version of the <code class="docutils literal notranslate"><span class="pre">build_model</span></code> function defined in <code class="docutils literal notranslate"><span class="pre">CFUtils.py</span></code>. We modified this function to include two extra parameters:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">num_queries</span></code> - Defined as the number of users in our case. Used to define the length of the <span class="math notranslate nohighlight">\(U\)</span> user embedding.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num_items</span></code> - Defined as the number of artists in our case. Used to define the length of the <span class="math notranslate nohighlight">\(V\)</span> item embedding.</p></li>
</ul>
<p>The helper functions in <code class="docutils literal notranslate"><span class="pre">CFUtils.py</span></code>, and the <code class="docutils literal notranslate"><span class="pre">CFModel</span></code> class provided in <code class="docutils literal notranslate"><span class="pre">CFModel.py</span></code> were designed specifically for <a class="reference external" href="https://colab.research.google.com/github/google/eng-edu/blob/main/ml/recommendation-systems/recommendation-systems.ipynb?utm_source=ss-recommendation-systems&amp;utm_campaign=colab-external&amp;utm_medium=referral&amp;utm_content=recommendation-systems#scrollTo=_BlRIQJYo4tt">Recommendation System Colab</a>, meaning that the length of the embedding vectors were hard-coded in. The inclusion of these two extra parameters allows us to apply this model for new use-cases. In the cell below, we will do a trial run of our model and discuss the results after.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build the CF model and train it.</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="n">rating_matrix</span><span class="p">,</span> <span class="n">num_queries</span><span class="o">=</span><span class="n">num_users</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="n">num_artists</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">init_stddev</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">num_iterations</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">10.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:From D:\DCU\4th_year\CA4015\CA4015-Music-RecSystem\book\CFModel.py:55: start_queue_runners (from tensorflow.python.training.queue_runner_impl) is deprecated and will be removed in a future version.
Instructions for updating:
To construct input pipelines, use the `tf.data` module.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:`tf.train.start_queue_runners()` was called when no queue runners were defined. You can safely remove the call to this deprecated function.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> iteration 0: train_error=1.000301, test_error=0.999400
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> iteration 10: train_error=0.999591, test_error=0.999400
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> iteration 20: train_error=0.998872, test_error=0.999390
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> iteration 30: train_error=0.998135, test_error=0.999364
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> iteration 40: train_error=0.997367, test_error=0.999311
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> iteration 50: train_error=0.996554, test_error=0.999218
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> iteration 60: train_error=0.995677, test_error=0.999069
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> iteration 70: train_error=0.994709, test_error=0.998840
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> iteration 80: train_error=0.993617, test_error=0.998500
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="o">~</span>\<span class="n">AppData</span>\<span class="n">Local</span>\<span class="n">Temp</span><span class="o">/</span><span class="n">ipykernel_1660</span><span class="o">/</span><span class="mf">1265995664.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># Build the CF model and train it.</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">model</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span><span class="n">rating_matrix</span><span class="p">,</span> <span class="n">num_queries</span><span class="o">=</span><span class="n">num_users</span><span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="n">num_artists</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">init_stddev</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">num_iterations</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">10.</span><span class="p">)</span>

<span class="nn">D:\DCU\4th_year\CA4015\CA4015-Music-RecSystem\book\CFModel.py</span> in <span class="ni">train</span><span class="nt">(self, num_iterations, learning_rate, plot_results, optimizer)</span>
<span class="g g-Whitespace">     </span><span class="mi">63</span>             <span class="c1"># Train and append results.</span>
<span class="g g-Whitespace">     </span><span class="mi">64</span>             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_iterations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
<span class="ne">---&gt; </span><span class="mi">65</span>                 <span class="n">_</span><span class="p">,</span> <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">run</span><span class="p">((</span><span class="n">train_op</span><span class="p">,</span> <span class="n">metrics</span><span class="p">))</span>
<span class="g g-Whitespace">     </span><span class="mi">66</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="n">num_iterations</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">67</span>                     <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2"> iteration </span><span class="si">%d</span><span class="s2">: &quot;</span> <span class="o">%</span> <span class="n">i</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>

<span class="nn">~\AppData\Roaming\Python\Python38\site-packages\tensorflow\python\client\session.py</span> in <span class="ni">run</span><span class="nt">(self, fetches, feed_dict, options, run_metadata)</span>
<span class="g g-Whitespace">    </span><span class="mi">968</span> 
<span class="g g-Whitespace">    </span><span class="mi">969</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">970</span>       <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">fetches</span><span class="p">,</span> <span class="n">feed_dict</span><span class="p">,</span> <span class="n">options_ptr</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">971</span>                          <span class="n">run_metadata_ptr</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">972</span>       <span class="k">if</span> <span class="n">run_metadata</span><span class="p">:</span>

<span class="nn">~\AppData\Roaming\Python\Python38\site-packages\tensorflow\python\client\session.py</span> in <span class="ni">_run</span><span class="nt">(self, handle, fetches, feed_dict, options, run_metadata)</span>
<span class="g g-Whitespace">   </span><span class="mi">1191</span>     <span class="c1"># or if the call is a partial run that specifies feeds.</span>
<span class="g g-Whitespace">   </span><span class="mi">1192</span>     <span class="k">if</span> <span class="n">final_fetches</span> <span class="ow">or</span> <span class="n">final_targets</span> <span class="ow">or</span> <span class="p">(</span><span class="n">handle</span> <span class="ow">and</span> <span class="n">feed_dict_tensor</span><span class="p">):</span>
<span class="ne">-&gt; </span><span class="mi">1193</span>       <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_run</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">final_targets</span><span class="p">,</span> <span class="n">final_fetches</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1194</span>                              <span class="n">feed_dict_tensor</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">run_metadata</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1195</span>     <span class="k">else</span><span class="p">:</span>

<span class="nn">~\AppData\Roaming\Python\Python38\site-packages\tensorflow\python\client\session.py</span> in <span class="ni">_do_run</span><span class="nt">(self, handle, target_list, fetch_list, feed_dict, options, run_metadata)</span>
<span class="g g-Whitespace">   </span><span class="mi">1371</span> 
<span class="g g-Whitespace">   </span><span class="mi">1372</span>     <span class="k">if</span> <span class="n">handle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1373</span>       <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_call</span><span class="p">(</span><span class="n">_run_fn</span><span class="p">,</span> <span class="n">feeds</span><span class="p">,</span> <span class="n">fetches</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1374</span>                            <span class="n">run_metadata</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1375</span>     <span class="k">else</span><span class="p">:</span>

<span class="nn">~\AppData\Roaming\Python\Python38\site-packages\tensorflow\python\client\session.py</span> in <span class="ni">_do_call</span><span class="nt">(self, fn, *args)</span>
<span class="g g-Whitespace">   </span><span class="mi">1378</span>   <span class="k">def</span> <span class="nf">_do_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1379</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1380</span>       <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1381</span>     <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">OpError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1382</span>       <span class="n">message</span> <span class="o">=</span> <span class="n">compat</span><span class="o">.</span><span class="n">as_text</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>

<span class="nn">~\AppData\Roaming\Python\Python38\site-packages\tensorflow\python\client\session.py</span> in <span class="ni">_run_fn</span><span class="nt">(feed_dict, fetch_list, target_list, options, run_metadata)</span>
<span class="g g-Whitespace">   </span><span class="mi">1361</span>       <span class="c1"># Ensure any changes to the graph are reflected in the runtime.</span>
<span class="g g-Whitespace">   </span><span class="mi">1362</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_extend_graph</span><span class="p">()</span>
<span class="ne">-&gt; </span><span class="mi">1363</span>       <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_tf_sessionrun</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">feed_dict</span><span class="p">,</span> <span class="n">fetch_list</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1364</span>                                       <span class="n">target_list</span><span class="p">,</span> <span class="n">run_metadata</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1365</span> 

<span class="nn">~\AppData\Roaming\Python\Python38\site-packages\tensorflow\python\client\session.py</span> in <span class="ni">_call_tf_sessionrun</span><span class="nt">(self, options, feed_dict, fetch_list, target_list, run_metadata)</span>
<span class="g g-Whitespace">   </span><span class="mi">1454</span>   <span class="k">def</span> <span class="nf">_call_tf_sessionrun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">feed_dict</span><span class="p">,</span> <span class="n">fetch_list</span><span class="p">,</span> <span class="n">target_list</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1455</span>                           <span class="n">run_metadata</span><span class="p">):</span>
<span class="ne">-&gt; </span><span class="mi">1456</span>     <span class="k">return</span> <span class="n">tf_session</span><span class="o">.</span><span class="n">TF_SessionRun_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">feed_dict</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1457</span>                                             <span class="n">fetch_list</span><span class="p">,</span> <span class="n">target_list</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1458</span>                                             <span class="n">run_metadata</span><span class="p">)</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
<p>In the above graph, it can be observed that both <code class="docutils literal notranslate"><span class="pre">train_eror</span></code> and <code class="docutils literal notranslate"><span class="pre">test_error</span></code> are small values, indicating good performance of the model overall. However, we already know that the recommendations for this basic model will likely be poor.</p>
<p>Let’s take a closer look at our embeddings. We’ll view the embeddings near ‘Adele’.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">item_neighbors</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">title_substring</span><span class="o">=</span><span class="s2">&quot;Adele&quot;</span><span class="p">,</span> <span class="n">measure</span><span class="o">=</span><span class="s1">&#39;dot&#39;</span><span class="p">,</span> <span class="n">items</span><span class="o">=</span><span class="n">artists</span><span class="p">)</span>
<span class="n">item_neighbors</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">title_substring</span><span class="o">=</span><span class="s2">&quot;Adele&quot;</span><span class="p">,</span> <span class="n">measure</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">,</span> <span class="n">items</span><span class="o">=</span><span class="n">artists</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Nearest neighbors of : Adele.
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dot score</th>
      <th>name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1919</th>
      <td>1.196</td>
      <td>Adele</td>
    </tr>
    <tr>
      <th>1444</th>
      <td>1.168</td>
      <td>Selena Gomez</td>
    </tr>
    <tr>
      <th>334</th>
      <td>1.164</td>
      <td>Cher</td>
    </tr>
    <tr>
      <th>518</th>
      <td>1.161</td>
      <td>Jeffree Star</td>
    </tr>
    <tr>
      <th>303</th>
      <td>1.153</td>
      <td>Danity Kane</td>
    </tr>
    <tr>
      <th>1449</th>
      <td>1.152</td>
      <td>Miranda Cosgrove</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Nearest neighbors of : Adele.
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cosine score</th>
      <th>name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1919</th>
      <td>1.000</td>
      <td>Adele</td>
    </tr>
    <tr>
      <th>1444</th>
      <td>0.954</td>
      <td>Selena Gomez</td>
    </tr>
    <tr>
      <th>1449</th>
      <td>0.951</td>
      <td>Miranda Cosgrove</td>
    </tr>
    <tr>
      <th>518</th>
      <td>0.950</td>
      <td>Jeffree Star</td>
    </tr>
    <tr>
      <th>532</th>
      <td>0.950</td>
      <td>Maroon 5</td>
    </tr>
    <tr>
      <th>680</th>
      <td>0.949</td>
      <td>Selena Gomez &amp; the Scene</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="section" id="current-model-predictions">
<h3>Current Model Predictions<a class="headerlink" href="#current-model-predictions" title="Permalink to this headline">¶</a></h3>
<p>At a glance, the embeddings closest to Adele seem reasonable, in the sense that they are all popular artist names that are somewhat familiar. This makes sense, Adele being one of the most popular artists in 2011.</p>
<p>With basic recommendation systems, we often observe the appearance of ‘niche’ items (artists in our case) near our embeddings. This is due to the fact that these little-known artists can have a randomly assigned norm with a high value that is never corrected. We somewhat avoid this issue in our model generation by incorporating a relatively small <code class="docutils literal notranslate"><span class="pre">init_stddev</span></code> value of 0.05.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">CFUtils</span> <span class="kn">import</span> <span class="n">tsne_item_embeddings</span><span class="p">,</span> <span class="n">visualize_item_embeddings</span><span class="p">,</span> <span class="n">item_embedding_norm</span><span class="p">,</span> <span class="n">build_regularized_model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">item_embedding_norm</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">artist_tot_listens</span><span class="p">,</span> <span class="n">rating_matrix</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Matrix_Factorization_28_0.png" src="_images/Matrix_Factorization_28_0.png" />
</div>
</div>
</div>
<div class="section" id="norm-analysis">
<h3>Norm Analysis<a class="headerlink" href="#norm-analysis" title="Permalink to this headline">¶</a></h3>
<p>Viewing the relation between the number of users who listen to an artist and that artist’s norm, we see that our norm values are somewhat reasonable. The values seem to plateaux near the top. This results in lesser known artists unreasonably receiving higher norm values. Again, instantiating the norms using a normal distribution with a small standard deviation ensures that few niche artists receive high norms. This does not completely solve the issue.</p>
<p>To correct this behaviour, we can use regularization terms. Regularization terms introduce some bias in to our data which aims to reduce the impact of the behaviour previously discussed. We should expect to see less-performant error scores for our regularized model. This is okay however, as we should see improved recommendations being made.</p>
</div>
<hr class="docutils" />
<div class="section" id="regularisation">
<h3>Regularisation<a class="headerlink" href="#regularisation" title="Permalink to this headline">¶</a></h3>
<p>We’ll now use two regularization techniques defined and discussed in our introduction section. Namely, <em>L2 Regularization</em>, and <em>Gravity Term</em> regularization. Essentially, these two terms aim to correct embeddings after they are initialised.</p>
<p>Our <code class="docutils literal notranslate"><span class="pre">build_regularized_model()</span></code> helper function defines both of our regularization terms and combines them into our <code class="docutils literal notranslate"><span class="pre">total_loss</span></code> function which is then provided to our <code class="docutils literal notranslate"><span class="pre">CFModel</span></code> class in place of the previous simplistic loss function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reg_model</span> <span class="o">=</span> <span class="n">build_regularized_model</span><span class="p">(</span>
    <span class="n">rating_matrix</span><span class="p">,</span> <span class="n">num_queries</span><span class="o">=</span><span class="n">num_users</span> <span class="p">,</span> <span class="n">num_items</span><span class="o">=</span><span class="n">num_artists</span><span class="p">,</span> <span class="n">regularization_coeff</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">gravity_coeff</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span> <span class="n">init_stddev</span><span class="o">=.</span><span class="mi">05</span><span class="p">)</span>
<span class="n">reg_model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">num_iterations</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">20.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:From D:\DCU\4th_year\CA4015\CA4015-Music-RecSystem\book\CFModel.py:55: start_queue_runners (from tensorflow.python.training.queue_runner_impl) is deprecated and will be removed in a future version.
Instructions for updating:
To construct input pipelines, use the `tf.data` module.
WARNING:tensorflow:`tf.train.start_queue_runners()` was called when no queue runners were defined. You can safely remove the call to this deprecated function.
 iteration 2000: train_error_observed=0.296637, test_error_observed=0.326611, observed_loss=0.296637, regularization_loss=0.209359, gravity_loss=0.034404
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[{&#39;train_error_observed&#39;: 0.29663688, &#39;test_error_observed&#39;: 0.32661134},
 {&#39;observed_loss&#39;: 0.29663688,
  &#39;regularization_loss&#39;: 0.20935923,
  &#39;gravity_loss&#39;: 0.034403637}]
</pre></div>
</div>
<img alt="_images/Matrix_Factorization_30_2.png" src="_images/Matrix_Factorization_30_2.png" />
</div>
</div>
<div class="section" id="regularised-model-analysis">
<h4>Regularised Model Analysis<a class="headerlink" href="#regularised-model-analysis" title="Permalink to this headline">¶</a></h4>
<p>If we compare the graph on the left of our regularised model to the graph of our unregularised model, we can see that our regularised model has higher loss values. Higher loss values for an MF recommender system can be favourable to a certain degree. This is because our scoring functions (“DOT” and “COSINE”) regularly make recommendations for items based on popularity. It’s important for recommendation systems to include some type of personalisation in their recommendations, otherwise they will just recommend the most popular items to all users, which is useful to no one.</p>
<hr class="docutils" />
<p>As before, we can now take a closer look at our embeddings. Let’s once again view the embeddings near Adele, and try to interpret and compare them to our previous embeddings for our unregularised model. Let’s first inspect the dot product as our measure, followed by cosine.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">item_neighbors</span><span class="p">(</span><span class="n">reg_model</span><span class="p">,</span><span class="n">title_substring</span><span class="o">=</span><span class="s2">&quot;Adele&quot;</span><span class="p">,</span> <span class="n">measure</span><span class="o">=</span><span class="s1">&#39;dot&#39;</span><span class="p">,</span> <span class="n">items</span><span class="o">=</span><span class="n">artists</span><span class="p">)</span>
<span class="n">item_neighbors</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">title_substring</span><span class="o">=</span><span class="s2">&quot;Adele&quot;</span><span class="p">,</span> <span class="n">measure</span><span class="o">=</span><span class="s1">&#39;dot&#39;</span><span class="p">,</span> <span class="n">items</span><span class="o">=</span><span class="n">artists</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Nearest neighbors of : Adele.
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dot score</th>
      <th>name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>83</th>
      <td>4.443</td>
      <td>Lady Gaga</td>
    </tr>
    <tr>
      <th>61</th>
      <td>4.409</td>
      <td>Madonna</td>
    </tr>
    <tr>
      <th>283</th>
      <td>4.404</td>
      <td>Britney Spears</td>
    </tr>
    <tr>
      <th>282</th>
      <td>4.375</td>
      <td>Rihanna</td>
    </tr>
    <tr>
      <th>294</th>
      <td>4.375</td>
      <td>Katy Perry</td>
    </tr>
    <tr>
      <th>327</th>
      <td>4.375</td>
      <td>Avril Lavigne</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Nearest neighbors of : Adele.
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dot score</th>
      <th>name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1919</th>
      <td>1.196</td>
      <td>Adele</td>
    </tr>
    <tr>
      <th>1444</th>
      <td>1.168</td>
      <td>Selena Gomez</td>
    </tr>
    <tr>
      <th>334</th>
      <td>1.164</td>
      <td>Cher</td>
    </tr>
    <tr>
      <th>518</th>
      <td>1.161</td>
      <td>Jeffree Star</td>
    </tr>
    <tr>
      <th>303</th>
      <td>1.153</td>
      <td>Danity Kane</td>
    </tr>
    <tr>
      <th>1449</th>
      <td>1.152</td>
      <td>Miranda Cosgrove</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="dot-product-comparison-of-embeddings-in-regularised-and-unregularised">
<h4>Dot Product Comparison of Embeddings in Regularised and Unregularised<a class="headerlink" href="#dot-product-comparison-of-embeddings-in-regularised-and-unregularised" title="Permalink to this headline">¶</a></h4>
<p>I think it’s clear that although both models do make somewhat reasonable recommendations, the more appropriate embedding space is definitely found in the regularised model. The unregularised model seems to make less useful recommendations such as ‘Miranda Cosgrove’, and ‘Jefree Star’. The regularised model returns popular, solo-female artists that may not make music exactly similar to Adele, but were equally as popular as Adele in 2011.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">item_neighbors</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">title_substring</span><span class="o">=</span><span class="s2">&quot;Adele&quot;</span><span class="p">,</span> <span class="n">measure</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">,</span> <span class="n">items</span><span class="o">=</span><span class="n">artists</span><span class="p">)</span>
<span class="n">item_neighbors</span><span class="p">(</span><span class="n">reg_model</span><span class="p">,</span> <span class="n">title_substring</span><span class="o">=</span><span class="s2">&quot;Adele&quot;</span><span class="p">,</span> <span class="n">measure</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">,</span> <span class="n">items</span><span class="o">=</span><span class="n">artists</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Nearest neighbors of : Adele.
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cosine score</th>
      <th>name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1919</th>
      <td>1.000</td>
      <td>Adele</td>
    </tr>
    <tr>
      <th>1444</th>
      <td>0.954</td>
      <td>Selena Gomez</td>
    </tr>
    <tr>
      <th>1449</th>
      <td>0.951</td>
      <td>Miranda Cosgrove</td>
    </tr>
    <tr>
      <th>518</th>
      <td>0.950</td>
      <td>Jeffree Star</td>
    </tr>
    <tr>
      <th>532</th>
      <td>0.950</td>
      <td>Maroon 5</td>
    </tr>
    <tr>
      <th>680</th>
      <td>0.949</td>
      <td>Selena Gomez &amp; the Scene</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Nearest neighbors of : Adele.
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cosine score</th>
      <th>name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1919</th>
      <td>1.000</td>
      <td>Adele</td>
    </tr>
    <tr>
      <th>673</th>
      <td>0.999</td>
      <td>Glee Cast</td>
    </tr>
    <tr>
      <th>542</th>
      <td>0.999</td>
      <td>Ellie Goulding</td>
    </tr>
    <tr>
      <th>91</th>
      <td>0.999</td>
      <td>Duffy</td>
    </tr>
    <tr>
      <th>1043</th>
      <td>0.999</td>
      <td>Pink</td>
    </tr>
    <tr>
      <th>3061</th>
      <td>0.999</td>
      <td>Sara Bareilles</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="cosine-comparison-of-embeddings-in-regularised-and-unregularised">
<h4>Cosine Comparison of Embeddings in Regularised and Unregularised<a class="headerlink" href="#cosine-comparison-of-embeddings-in-regularised-and-unregularised" title="Permalink to this headline">¶</a></h4>
<p>We see a similar behaviour here, in that the regularised model embeddings are clearly more suitable. The appearance of <em>Glee Cast</em> as the most similar artist to Adele did seem like a strange recommendation. However, I found an <a class="reference external" href="https://tvline.com/2011/11/17/glee-adele-rumor-has-it-someone-like-you/">article</a> that gives meaning to this recommendation. In 2011, Glee aired a mash-up of Adele’s “Rumor Has It / Someone Like You” in one of their episodes which saw their iTunes song release reach No.1 on the charts.</p>
<p>Once again, we see the regularised model recommending popular solo-female artists from that time. Both cosine and dot product recommendations seem suitable for Adele.</p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="norm-embedding-analysis">
<h3>Norm Embedding Analysis<a class="headerlink" href="#norm-embedding-analysis" title="Permalink to this headline">¶</a></h3>
<p>As previously, we will now view our model embeddings. We can see in the below image that the regularised model was able to break the plateaux previously observed in the unregularised model. As a result, this model is able to give more appropriate recommendations.</p>
<p>The below graph visually shows an improvement over our unregularised model. We see that embeddings no longer plateaux beyond a certain point, which leads to better recommendations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">item_embedding_norm</span><span class="p">(</span><span class="n">reg_model</span><span class="p">,</span> <span class="n">artist_tot_listens</span><span class="p">,</span> <span class="n">rating_matrix</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Matrix_Factorization_36_0.png" src="_images/Matrix_Factorization_36_0.png" />
</div>
</div>
</div>
</div>
<span id="document-Deep_Learning_Recommender_System"></span><div class="section" id="deep-neural-network-recommender-system">
<h2>Deep Neural Network Recommender System<a class="headerlink" href="#deep-neural-network-recommender-system" title="Permalink to this headline">¶</a></h2>
<p>In this Notebook, we will build another music recommendation system. This time, we will incorporate a deep learning approach as explained in the introduction. We will be using Keras on Tensorflow V2 for this model. Keras is a high-level API built on-top of Tensorflow. It offers a range of utilities for getting started with recommender systems which we will use throughout this Notebook.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">tempfile</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Text</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tensorflow_recommenders</span> <span class="k">as</span> <span class="nn">tfrs</span>
<span class="kn">import</span> <span class="nn">tensorflow_datasets</span> <span class="k">as</span> <span class="nn">tfds</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="data-preprocessing">
<h3>Data Preprocessing<a class="headerlink" href="#data-preprocessing" title="Permalink to this headline">¶</a></h3>
<p>Here we just repeat some data preprocessing steps as previous. However, we will incorporate a new way to normalise our weight values. In the previous notebook, the normalised weight values lead to poor performance of the model. Because of this, we opted to use a binary model. However, in this notebook we will normalise the weight column on a per user basis. This will be discussed shortly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Let&#39;s define our amount of users</span>
<span class="n">rating_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/user_artists.dat&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
<span class="n">num_users</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rating_matrix</span><span class="o">.</span><span class="n">userID</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="c1">#Extract userID column</span>
<span class="n">userids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rating_matrix</span><span class="o">.</span><span class="n">userID</span><span class="p">)</span>

<span class="c1">#Remap the column</span>
<span class="n">u_mapper</span><span class="p">,</span> <span class="n">u_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">userids</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Let&#39;s define our amount of artists</span>
<span class="n">artists</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/artists.dat&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
<span class="n">artists</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="s1">&#39;artistID&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">num_artists</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">artists</span><span class="o">.</span><span class="n">artistID</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="c1">#Extract artistID column</span>
<span class="n">artistids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rating_matrix</span><span class="o">.</span><span class="n">artistID</span><span class="p">)</span>

<span class="c1">#Remap the column</span>
<span class="n">a_mapper</span><span class="p">,</span> <span class="n">a_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">artistids</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s replace old columns with new ind ones</span>
<span class="n">rating_matrix</span><span class="o">.</span><span class="n">userID</span> <span class="o">=</span> <span class="n">u_ind</span>
<span class="n">rating_matrix</span><span class="o">.</span><span class="n">artistID</span> <span class="o">=</span> <span class="n">a_ind</span>

<span class="c1">#Let&#39;s ensure the max value is approriate</span>
<span class="k">assert</span><span class="p">(</span><span class="n">rating_matrix</span><span class="o">.</span><span class="n">userID</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1891</span><span class="p">)</span>
<span class="k">assert</span><span class="p">(</span><span class="n">rating_matrix</span><span class="o">.</span><span class="n">artistID</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">17631</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#We convert the ID&#39;s to string so we can use the StringLookup function later</span>
<span class="n">rating_matrix</span><span class="o">.</span><span class="n">userID</span> <span class="o">=</span> <span class="n">rating_matrix</span><span class="o">.</span><span class="n">userID</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">rating_matrix</span><span class="o">.</span><span class="n">artistID</span> <span class="o">=</span> <span class="n">rating_matrix</span><span class="o">.</span><span class="n">artistID</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="normalising-the-weight-column">
<h3>Normalising the ‘weight’ Column<a class="headerlink" href="#normalising-the-weight-column" title="Permalink to this headline">¶</a></h3>
<p>Rather than normalising the entire weight column as one array, we can normalise the values for each user individually. Simply put, the artist that a particular user listens to the most will have a high value such as 1. The artist they listen to the least will be closer to 0.</p>
<p>This is a better representation of a user’s preferences than normalising the entire weight column, which can lead to very insignificant values. Normalising the entire weight column will lead to user-artist pairs having small values for weight solely because other users have listened to more music in general.</p>
<p>In the following function, we create a new rating matrix which is populated by each users ratings one at a time. Once this is complete, we replace our old <code class="docutils literal notranslate"><span class="pre">rating_matrix</span></code> variable with <code class="docutils literal notranslate"><span class="pre">new_rating_matrix</span></code> to keep continuity of naming conventions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Let&#39;s normalise our weight column</span>
<span class="n">new_rating_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;userID&#39;</span><span class="p">,</span> <span class="s1">&#39;artistID&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="n">rating_matrix</span><span class="o">.</span><span class="n">userID</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
    <span class="n">user_ratings</span> <span class="o">=</span> <span class="n">rating_matrix</span><span class="p">[</span><span class="n">rating_matrix</span><span class="o">.</span><span class="n">userID</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">]</span>
    <span class="n">ratings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">user_ratings</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">])</span>
    <span class="n">user_ratings</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">new_rating_matrix</span> <span class="o">=</span> <span class="n">new_rating_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_ratings</span><span class="p">)</span>
<span class="n">rating_matrix</span> <span class="o">=</span> <span class="n">new_rating_matrix</span>
<span class="n">rating_matrix</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\seanc\AppData\Local\Temp/ipykernel_1744/4251931852.py:6: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  user_ratings[&#39;weight&#39;] = tf.keras.utils.normalize(ratings, axis=-1, order=2)[0]
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>weight</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>92834.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>0.091235</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.109804</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000008</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>0.030397</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>0.062543</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>0.109109</td>
    </tr>
    <tr>
      <th>max</th>
      <td>1.000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="create-dataset">
<h3>Create DataSet<a class="headerlink" href="#create-dataset" title="Permalink to this headline">¶</a></h3>
<p>In the following cells, we will be creating a tensor DataSet using the <code class="docutils literal notranslate"><span class="pre">from_tensor_slices()</span></code> function. We must firstly create our <code class="docutils literal notranslate"><span class="pre">interactions_dict</span></code>, which is just our rating_matrix in dictionary form.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## we tansform the table inta a dictionary , which then we feed into tensor slices</span>
<span class="c1"># this step is crucial as this will be the type of data fed into the embedding layers</span>
<span class="n">interactions_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">rating_matrix</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">interactions</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">interactions_dict</span><span class="p">)</span>

<span class="c1">## we do similar step for item, where this is the reference table for items to be recommended</span>
<span class="n">items_dict</span> <span class="o">=</span> <span class="n">rating_matrix</span><span class="p">[[</span><span class="s1">&#39;artistID&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
<span class="n">items_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">items_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">items</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">items_dict</span><span class="p">)</span>

<span class="c1">## map the features in interactions and items to an identifier that we will use throught the embedding layers</span>
<span class="c1">## do it for all the items in interaction and item table</span>
<span class="c1">## you may often get itemtype error, so that is why here i am casting the quantity type as float to ensure consistency</span>
<span class="n">interactions</span> <span class="o">=</span> <span class="n">interactions</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;userID&#39;</span> <span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;userID&#39;</span><span class="p">],</span> 
                                            <span class="s1">&#39;artistID&#39;</span> <span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;artistID&#39;</span><span class="p">],</span> 
                                            <span class="s1">&#39;weight&#39;</span> <span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]})</span>

<span class="n">items</span> <span class="o">=</span> <span class="n">items</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;artistID&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>We must also create variables representing our unique user ID’s and artist ID’s.</p>
<p>This will allow us to map the raw values of our categorical features to embeddings vectors in our models. For this, we need a vocabulary mapping raw feature values to an integfer in a contiguous range. This allows us to look up the corresponding embeddings in our tables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### get unique item and user id&#39;s as a lookup table</span>
<span class="n">unique_artist_ids</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">a_ind</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">unique_user_ids</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">u_ind</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<span class="c1"># Randomly shuffle data and split between train and test.</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">shuffled</span> <span class="o">=</span> <span class="n">interactions</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="mi">100_000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">reshuffle_each_iteration</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">shuffled</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">62_000</span><span class="p">)</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">shuffled</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="mi">62_000</span><span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">30_000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;our test set is: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;our train set is: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>our test set is: 62000
our train set is: 30000
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="simple-retrieval-model">
<h3>Simple Retrieval Model<a class="headerlink" href="#simple-retrieval-model" title="Permalink to this headline">¶</a></h3>
<p>In the following cells, we define a simple retrieval model. Although defined differently, this model works on the same principals as our previous matrix factorisation model. We just include this step as a progression towards a more advanced deep learning model.</p>
<p>The TFRS package with Keras makes development of recommender systems simple and intuitive. We simply inherit from the base <code class="docutils literal notranslate"><span class="pre">tfrs.Model</span></code> class, define our query (user) and item (artist) towers or embeddings, then define our loss function and metrics to be used and our model is ready to deploy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Basic retrieval model</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_model</span><span class="p">,</span> <span class="n">item_model</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1">### we pass the embedding layer into item model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_model</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span> <span class="o">=</span> <span class="n">item_model</span>
            
        <span class="c1">### We pass the embedding layer into user model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_model</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span> <span class="o">=</span> <span class="n">user_model</span>
        
        <span class="c1">### for retrieval model. we take top-k accuracy as metrics</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">tfrs</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">FactorizedTopK</span><span class="p">(</span><span class="n">candidates</span><span class="o">=</span><span class="n">items</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">item_model</span><span class="p">))</span>
        
        <span class="c1"># define the task, which is retrieval                                        </span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">tfrs</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">Retrieval</span><span class="p">(</span><span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span> <span class="o">=</span> <span class="n">task</span>

    <span class="k">def</span> <span class="nf">compute_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Text</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="c1"># We pick out the user features and pass them into the user model.</span>
        <span class="n">user_embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_model</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;userID&quot;</span><span class="p">])</span>
        <span class="c1"># And pick out the item features and pass them into the item model,</span>
        <span class="c1"># getting embeddings back.</span>
        <span class="n">positive_item_embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_model</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;artistID&quot;</span><span class="p">])</span>

        <span class="c1"># The task computes the loss and the metrics.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">user_embeddings</span><span class="p">,</span> <span class="n">positive_item_embeddings</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">  File</span><span class="nn"> &quot;C:\Users\seanc\AppData\Local\Temp/ipykernel_1744/2244004975.py&quot;</span><span class="gt">, line </span><span class="mi">2</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_model</span><span class="p">,</span> <span class="n">item_model</span><span class="p">):</span>
    <span class="o">^</span>
<span class="ne">IndentationError</span>: unexpected indent
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="train-and-evaluate-model">
<h3>Train and Evaluate Model<a class="headerlink" href="#train-and-evaluate-model" title="Permalink to this headline">¶</a></h3>
<p>The following cell is used to train and evaluate our model. We firstly define the size of our embedding dimensions. Then, we build our user and item embedding vectors using <code class="docutils literal notranslate"><span class="pre">tf.keras.layers.Embedding</span></code>. In this function, we add an additional embedding layer to account for unknown tokens (if any).</p>
<p>We simply instantiate our model and compile it with an optimisation function of our choice. We will use Adagrad in this instance. We then fit the model on our training data and provide our number of epochs. Following from this, we fit the data on our test set.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### Fitting and evaluating</span>
<span class="c1">### we choose the dimensionality of the query and candicate representation.</span>
<span class="n">embedding_dimension</span> <span class="o">=</span> <span class="mi">32</span>
<span class="c1">## we pass the model, which is the same model we created in the query and candidate tower, into the model</span>
<span class="n">user_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
    <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">StringLookup</span><span class="p">(</span>
                                <span class="n">vocabulary</span><span class="o">=</span><span class="n">unique_user_ids</span><span class="p">,</span> <span class="n">mask_token</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
                                <span class="c1"># We add an additional embedding to account for unknown tokens.</span>
                                <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_user_ids</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">embedding_dimension</span><span class="p">)])</span>

<span class="n">item_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
    <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">StringLookup</span><span class="p">(</span>
                                <span class="n">vocabulary</span><span class="o">=</span><span class="n">unique_artist_ids</span><span class="p">,</span> <span class="n">mask_token</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
                                <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_artist_ids</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">embedding_dimension</span><span class="p">)])</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">MusicModel</span><span class="p">(</span><span class="n">user_model</span><span class="p">,</span> <span class="n">item_model</span><span class="p">)</span>

<span class="c1"># a smaller learning rate may make the model move slower and prone to overfitting, so we stick to 0.1</span>
<span class="c1"># other optimizers, such as SGD and Adam, are listed here https://www.tensorflow.org/api_docs/python/tf/keras/optimizers</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adagrad</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span>
<span class="n">cached_train</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="mi">100_000</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">10_000</span><span class="p">)</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
<span class="n">cached_test</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">10_000</span><span class="p">)</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>

<span class="c1">## fit the model with ten epochs</span>
<span class="n">model_hist</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cached_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1">#evaluate the model</span>
<span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">cached_test</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># num_validation_runs = len(one_layer_history.history[&quot;val_factorized_top_k/top_100_categorical_accuracy&quot;])</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">model_hist</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;factorized_top_k/top_100_categorical_accuracy&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;accuracy&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Accuracy vs epoch&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Top-100 accuracy&quot;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/10
7/7 [==============================] - 54s 7s/step - factorized_top_k/top_1_categorical_accuracy: 0.0016 - factorized_top_k/top_5_categorical_accuracy: 0.0114 - factorized_top_k/top_10_categorical_accuracy: 0.0237 - factorized_top_k/top_50_categorical_accuracy: 0.0783 - factorized_top_k/top_100_categorical_accuracy: 0.1086 - loss: 72704.5215 - regularization_loss: 0.0000e+00 - total_loss: 72704.5215  
Epoch 2/10
7/7 [==============================] - 57s 8s/step - factorized_top_k/top_1_categorical_accuracy: 0.0080 - factorized_top_k/top_5_categorical_accuracy: 0.0430 - factorized_top_k/top_10_categorical_accuracy: 0.0805 - factorized_top_k/top_50_categorical_accuracy: 0.2462 - factorized_top_k/top_100_categorical_accuracy: 0.3486 - loss: 69661.6450 - regularization_loss: 0.0000e+00 - total_loss: 69661.6450
Epoch 3/10
7/7 [==============================] - 58s 8s/step - factorized_top_k/top_1_categorical_accuracy: 0.0091 - factorized_top_k/top_5_categorical_accuracy: 0.0512 - factorized_top_k/top_10_categorical_accuracy: 0.0927 - factorized_top_k/top_50_categorical_accuracy: 0.2789 - factorized_top_k/top_100_categorical_accuracy: 0.3953 - loss: 65582.3188 - regularization_loss: 0.0000e+00 - total_loss: 65582.3188
Epoch 4/10
7/7 [==============================] - 58s 8s/step - factorized_top_k/top_1_categorical_accuracy: 0.0099 - factorized_top_k/top_5_categorical_accuracy: 0.0615 - factorized_top_k/top_10_categorical_accuracy: 0.1117 - factorized_top_k/top_50_categorical_accuracy: 0.3244 - factorized_top_k/top_100_categorical_accuracy: 0.4520 - loss: 61863.0859 - regularization_loss: 0.0000e+00 - total_loss: 61863.0859
Epoch 5/10
7/7 [==============================] - 58s 8s/step - factorized_top_k/top_1_categorical_accuracy: 0.0100 - factorized_top_k/top_5_categorical_accuracy: 0.0696 - factorized_top_k/top_10_categorical_accuracy: 0.1288 - factorized_top_k/top_50_categorical_accuracy: 0.3822 - factorized_top_k/top_100_categorical_accuracy: 0.5333 - loss: 58430.2305 - regularization_loss: 0.0000e+00 - total_loss: 58430.2305
Epoch 6/10
7/7 [==============================] - 59s 8s/step - factorized_top_k/top_1_categorical_accuracy: 0.0091 - factorized_top_k/top_5_categorical_accuracy: 0.0715 - factorized_top_k/top_10_categorical_accuracy: 0.1387 - factorized_top_k/top_50_categorical_accuracy: 0.4615 - factorized_top_k/top_100_categorical_accuracy: 0.6190 - loss: 55323.5352 - regularization_loss: 0.0000e+00 - total_loss: 55323.5352
Epoch 7/10
7/7 [==============================] - 58s 8s/step - factorized_top_k/top_1_categorical_accuracy: 0.0079 - factorized_top_k/top_5_categorical_accuracy: 0.0679 - factorized_top_k/top_10_categorical_accuracy: 0.1340 - factorized_top_k/top_50_categorical_accuracy: 0.5257 - factorized_top_k/top_100_categorical_accuracy: 0.6553 - loss: 52639.0669 - regularization_loss: 0.0000e+00 - total_loss: 52639.0669
Epoch 8/10
7/7 [==============================] - 58s 8s/step - factorized_top_k/top_1_categorical_accuracy: 0.0060 - factorized_top_k/top_5_categorical_accuracy: 0.0604 - factorized_top_k/top_10_categorical_accuracy: 0.1397 - factorized_top_k/top_50_categorical_accuracy: 0.5488 - factorized_top_k/top_100_categorical_accuracy: 0.6621 - loss: 50468.8599 - regularization_loss: 0.0000e+00 - total_loss: 50468.8599
Epoch 9/10
7/7 [==============================] - 62s 9s/step - factorized_top_k/top_1_categorical_accuracy: 0.0044 - factorized_top_k/top_5_categorical_accuracy: 0.0600 - factorized_top_k/top_10_categorical_accuracy: 0.1734 - factorized_top_k/top_50_categorical_accuracy: 0.5566 - factorized_top_k/top_100_categorical_accuracy: 0.6640 - loss: 48793.3975 - regularization_loss: 0.0000e+00 - total_loss: 48793.3975
Epoch 10/10
7/7 [==============================] - 59s 8s/step - factorized_top_k/top_1_categorical_accuracy: 0.0037 - factorized_top_k/top_5_categorical_accuracy: 0.0724 - factorized_top_k/top_10_categorical_accuracy: 0.2022 - factorized_top_k/top_50_categorical_accuracy: 0.5613 - factorized_top_k/top_100_categorical_accuracy: 0.6661 - loss: 47525.4175 - regularization_loss: 0.0000e+00 - total_loss: 47525.4175
3/3 [==============================] - 29s 9s/step - factorized_top_k/top_1_categorical_accuracy: 1.3333e-04 - factorized_top_k/top_5_categorical_accuracy: 0.0015 - factorized_top_k/top_10_categorical_accuracy: 0.0056 - factorized_top_k/top_50_categorical_accuracy: 0.0702 - factorized_top_k/top_100_categorical_accuracy: 0.1372 - loss: 89393.0645 - regularization_loss: 0.0000e+00 - total_loss: 89393.0645
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x15d8642d3d0&gt;
</pre></div>
</div>
<img alt="_images/Deep_Learning_Recommender_System_18_2.png" src="_images/Deep_Learning_Recommender_System_18_2.png" />
</div>
</div>
</div>
<div class="section" id="simple-retrieval-model-analysis">
<h3>Simple Retrieval Model Analysis<a class="headerlink" href="#simple-retrieval-model-analysis" title="Permalink to this headline">¶</a></h3>
<p>The above model trains for 10 epoch and is then evaluated on testing data. In the training epoch information, we see information such as <code class="docutils literal notranslate"><span class="pre">top_5_categorical_accuracy</span></code>. This is indicative of the models ability to return a true-positive in the top-5 retrieved items (artists) from the entire set. We see that for each epoch, the model generally gets better at returning true-positives.</p>
<p>In the evaluation information, we see these accuracies drop significantly. This signifies that are model is overfitting to our training data. We can introduce regularisation terms as previous to mitigate this effect. Also, in deep learning models, we may introduce more user and artist features that help the model generalise better.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a model that takes in raw query features, and</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">tfrs</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">factorized_top_k</span><span class="o">.</span><span class="n">BruteForce</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">user_model</span><span class="p">)</span>
<span class="c1"># recommends item out of the entire items dataset.</span>
<span class="n">index</span><span class="o">.</span><span class="n">index_from_dataset</span><span class="p">(</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">zip</span><span class="p">(</span><span class="n">items</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">item_model</span><span class="p">)))</span>

<span class="c1"># Get recommendations.</span>
<span class="n">j</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">_</span><span class="p">,</span> <span class="n">titles</span> <span class="o">=</span> <span class="n">index</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([</span><span class="n">j</span><span class="p">]))</span>

<span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">titles</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">artist_id</span> <span class="ow">in</span> <span class="n">arr</span><span class="p">:</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">artists</span><span class="p">[</span><span class="n">artists</span><span class="p">[</span><span class="s1">&#39;artistID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">artist_id</span><span class="p">)][</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
<span class="n">names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recommendations for user %s: </span><span class="si">{</span><span class="n">names</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Recommendations for user 10: [[&#39;Savage Garden&#39;]
 [&#39;Ke$ha&#39;]
 [&#39;Library Tapes&#39;]
 [&#39;nevershoutnever!&#39;]
 [&#39;Poney Express&#39;]
 [&#39;Ra Ra Riot&#39;]
 [&#39;The Rakes&#39;]
 [&#39;Astrud Gilberto&#39;]
 [&#39;Bon Iver&#39;]
 [&#39;Metro Station&#39;]]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="ranking-model">
<h3>Ranking Model<a class="headerlink" href="#ranking-model" title="Permalink to this headline">¶</a></h3>
<p>In the following cells, we will upgrade from our previous model by using a ranking model. In this model, we will be making use of <code class="docutils literal notranslate"><span class="pre">dense</span></code> keras layers with ‘RELU’ activation functions. This is a deep learning approach. We will also be attempting to make use of the explicit rating values in the <code class="docutils literal notranslate"><span class="pre">weight</span></code> column of our rating matrix.</p>
<p>Moderm recommender systems usually operate in two stages:</p>
<ul class="simple">
<li><p>Retrieval</p></li>
<li><p>Ranking</p></li>
</ul>
<p>We will firstly define our <code class="docutils literal notranslate"><span class="pre">RankingModel</span></code> class which will act as our ranking model. Our <code class="docutils literal notranslate"><span class="pre">MusicModel</span></code> will act as the retrieval model as previous.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Define our ranking model</span>
<span class="k">class</span> <span class="nc">RankingModel</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">embedding_dimension</span> <span class="o">=</span> <span class="mi">32</span>

        <span class="c1">### we pass the embedding layer into item model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_model</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span> <span class="o">=</span> <span class="n">item_model</span>
            
        <span class="c1">### We pass the embedding layer into user model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_model</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span> <span class="o">=</span> <span class="n">user_model</span>

        <span class="c1"># Compute predictions.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratings</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
                      <span class="c1"># Learn multiple dense layers.</span>
                      <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">),</span>
                      <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">),</span>
                      <span class="c1"># Make rating predictions in the final layer.</span>
                      <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="n">user_id</span><span class="p">,</span> <span class="n">item_title</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="n">user_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_model</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">item_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_model</span><span class="p">(</span><span class="n">item_title</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ratings</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">user_embedding</span><span class="p">,</span> <span class="n">item_embedding</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Now our base retrieval model incorporates our ranking model</span>
<span class="k">class</span> <span class="nc">MusicModel</span><span class="p">(</span><span class="n">tfrs</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ranking_model</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span> <span class="o">=</span> <span class="n">RankingModel</span><span class="p">()</span>
            
        <span class="c1">#Let&#39;s define our Loss function and optimisation function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span> <span class="o">=</span> <span class="n">tfrs</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">Ranking</span><span class="p">(</span>
                          <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">MeanSquaredError</span><span class="p">(),</span>
                          <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">RootMeanSquaredError</span><span class="p">()])</span>
    
    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ranking_model</span><span class="p">(</span>
            <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;userID&quot;</span><span class="p">],</span> <span class="n">features</span><span class="p">[</span><span class="s2">&quot;artistID&quot;</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">compute_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Text</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="n">rating_predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ranking_model</span><span class="p">(</span>
            <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;userID&quot;</span><span class="p">],</span> <span class="n">features</span><span class="p">[</span><span class="s2">&quot;artistID&quot;</span><span class="p">]))</span>

        <span class="c1"># The task computes the loss and the metrics.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">],</span> <span class="n">predictions</span><span class="o">=</span><span class="n">rating_predictions</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Note</strong>: This model differs to our previous retrieval model as we are now incorporating the weight column, whereas our previous model worked solely on binary values. This Deep Learning Framework is more robust and can handle the disparity between values in our weight column. We normalised our weight column values earlier. This is an important preprocessing step to achieve good model performance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### Fitting and evaluating</span>
<span class="c1">### we choose the dimensionality of the query and candicate representation.</span>
<span class="n">embedding_dimension</span> <span class="o">=</span> <span class="mi">32</span>
<span class="c1">## we pass the model, which is the same model we created in the query and candidate tower, into the model</span>
<span class="n">user_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
    <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">StringLookup</span><span class="p">(</span>
                                <span class="n">vocabulary</span><span class="o">=</span><span class="n">unique_user_ids</span><span class="p">,</span> <span class="n">mask_token</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
                                <span class="c1"># We add an additional embedding to account for unknown tokens.</span>
                                <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_user_ids</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">embedding_dimension</span><span class="p">)])</span>

<span class="n">item_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
    <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">StringLookup</span><span class="p">(</span>
                                <span class="n">vocabulary</span><span class="o">=</span><span class="n">unique_artist_ids</span><span class="p">,</span> <span class="n">mask_token</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
                                <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_artist_ids</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">embedding_dimension</span><span class="p">)])</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">MusicModel</span><span class="p">()</span>

<span class="c1"># a smaller learning rate may make the model move slower and prone to overfitting, so we stick to 0.1</span>
<span class="c1"># other optimizers, such as SGD and Adam, are listed here https://www.tensorflow.org/api_docs/python/tf/keras/optimizers</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adagrad</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span>
<span class="n">cached_train</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="mi">100_000</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">10_000</span><span class="p">)</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
<span class="n">cached_test</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">10_000</span><span class="p">)</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>

<span class="c1">## fit the model with ten epochs</span>
<span class="n">model_hist</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cached_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1">#evaluate the model</span>
<span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">cached_test</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/10
7/7 [==============================] - 2s 78ms/step - root_mean_squared_error: 0.1133 - loss: 0.0129 - regularization_loss: 0.0000e+00 - total_loss: 0.0129
Epoch 2/10
7/7 [==============================] - 0s 48ms/step - root_mean_squared_error: 0.1097 - loss: 0.0123 - regularization_loss: 0.0000e+00 - total_loss: 0.0123
Epoch 3/10
7/7 [==============================] - 0s 48ms/step - root_mean_squared_error: 0.1096 - loss: 0.0123 - regularization_loss: 0.0000e+00 - total_loss: 0.0123
Epoch 4/10
7/7 [==============================] - 0s 44ms/step - root_mean_squared_error: 0.1095 - loss: 0.0123 - regularization_loss: 0.0000e+00 - total_loss: 0.0123
Epoch 5/10
7/7 [==============================] - 0s 48ms/step - root_mean_squared_error: 0.1095 - loss: 0.0123 - regularization_loss: 0.0000e+00 - total_loss: 0.0123
Epoch 6/10
7/7 [==============================] - 0s 50ms/step - root_mean_squared_error: 0.1094 - loss: 0.0122 - regularization_loss: 0.0000e+00 - total_loss: 0.0122
Epoch 7/10
7/7 [==============================] - 0s 49ms/step - root_mean_squared_error: 0.1094 - loss: 0.0122 - regularization_loss: 0.0000e+00 - total_loss: 0.0122
Epoch 8/10
7/7 [==============================] - 0s 45ms/step - root_mean_squared_error: 0.1093 - loss: 0.0122 - regularization_loss: 0.0000e+00 - total_loss: 0.0122
Epoch 9/10
7/7 [==============================] - 0s 45ms/step - root_mean_squared_error: 0.1093 - loss: 0.0122 - regularization_loss: 0.0000e+00 - total_loss: 0.0122
Epoch 10/10
7/7 [==============================] - 0s 48ms/step - root_mean_squared_error: 0.1093 - loss: 0.0122 - regularization_loss: 0.0000e+00 - total_loss: 0.0122
3/3 [==============================] - 1s 70ms/step - root_mean_squared_error: 0.1113 - loss: 0.0122 - regularization_loss: 0.0000e+00 - total_loss: 0.0122
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;root_mean_squared_error&#39;: 0.11132322996854782,
 &#39;loss&#39;: 0.011565779335796833,
 &#39;regularization_loss&#39;: 0,
 &#39;total_loss&#39;: 0.011565779335796833}
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="ranking-model-performance-analysis">
<h3>Ranking Model Performance Analysis<a class="headerlink" href="#ranking-model-performance-analysis" title="Permalink to this headline">¶</a></h3>
<p>We allowed our model to train for a total of 10 epochs before being evaluated on unseen testing data. Using RMSE as our objective function, we see this model is able to achieve great performance. The performance of our model does not drop significantly for unseen data.</p>
<p>Using RMSE as our metric allows us to quantitately compare the performance of this model with our previous matrix factorisation approach. In matrix factorisation, we achieved:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">'train_error':</span> <span class="pre">0.15067895,</span> <span class="pre">'test_error':</span> <span class="pre">0.23825963</span></code> for our unregularised model.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'train_error':</span> <span class="pre">0.29663688,</span> <span class="pre">'test_error':</span> <span class="pre">0.32661134</span></code> for our regularised model.</p></li>
</ul>
<p>We noted that the increase in error for our regularised model leads to better generalisations. In this deep learning model, we achieved:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">'train_error':</span> <span class="pre">0.1093,</span> <span class="pre">'test_error':</span> <span class="pre">0.1113</span></code>.</p></li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="qualitative-performance-analysis">
<h3>Qualitative Performance Analysis<a class="headerlink" href="#qualitative-performance-analysis" title="Permalink to this headline">¶</a></h3>
<p>Although the quantitative analysis of this model seems good, we do not know whether this leads to good recommendations or not. Let’s perform a qualitative analysis of the model. We’ll do the following:</p>
<ul class="simple">
<li><p>Take a typical user with a reasonable amount of artists they listen to</p></li>
<li><p>Sample 5 random artists they listen to</p></li>
<li><p>Along with the user id, provide the artist id’s selected to our model</p></li>
<li><p>We expect our model to return a ranking of these artist ID’s in the order that the user is most interested in them.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#User 100</span>
<span class="n">user_0</span> <span class="o">=</span> <span class="n">rating_matrix</span><span class="p">[</span><span class="n">rating_matrix</span><span class="p">[</span><span class="s1">&#39;userID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;100&quot;</span><span class="p">]</span>

<span class="c1">#Sample 5 artists they listen to</span>
<span class="n">user_0_sample</span> <span class="o">=</span> <span class="n">user_0</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">74</span><span class="p">)</span>
<span class="n">user_0_sample</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>userID</th>
      <th>artistID</th>
      <th>weight</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>4986</th>
      <td>100</td>
      <td>2649</td>
      <td>0.205387</td>
    </tr>
    <tr>
      <th>4980</th>
      <td>100</td>
      <td>2146</td>
      <td>0.164745</td>
    </tr>
    <tr>
      <th>4990</th>
      <td>100</td>
      <td>2653</td>
      <td>0.150230</td>
    </tr>
    <tr>
      <th>4972</th>
      <td>100</td>
      <td>769</td>
      <td>0.137167</td>
    </tr>
    <tr>
      <th>4996</th>
      <td>100</td>
      <td>2659</td>
      <td>0.083461</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The following cell takes in artist ID’s and a userID and computes a score for their combination. The model returns the artists in order of the scores they achieve. We expect this order to be similar to the order shown in the above sample.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_ratings</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">test_artist_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;2649&quot;</span><span class="p">,</span> <span class="s2">&quot;2146&quot;</span><span class="p">,</span> <span class="s2">&quot;2653&quot;</span><span class="p">,</span> <span class="s2">&quot;769&quot;</span><span class="p">,</span> <span class="s2">&quot;2659&quot;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">artistid</span> <span class="ow">in</span> <span class="n">test_artist_ids</span><span class="p">:</span>
    <span class="n">test_ratings</span><span class="p">[</span><span class="n">artistid</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="p">({</span>
        <span class="s2">&quot;userID&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;100&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;artistID&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">artistid</span><span class="p">])</span>
    <span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ratings:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">artist</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">test_ratings</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">artist</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ratings:
2649: [[0.09791555]]
2653: [[0.09428623]]
2146: [[0.0825875]]
769: [[0.08212695]]
2659: [[0.07627478]]
</pre></div>
</div>
</div>
</div>
<div class="section" id="output-analysis">
<h4>Output Analysis<a class="headerlink" href="#output-analysis" title="Permalink to this headline">¶</a></h4>
<p>We can see in the above cell that from the 5 sampled artists, our recommender system correctly identified the most liked artist as “2649”. The system did rank “2653” in second place, when in reality that artist is the user’s third favourite artist. However, the true ratings of the second and third most liked artist for this particular user differ only marginally.</p>
<p>From this small example, we can see that our model performs quite well.</p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="conclusion">
<h3>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h3>
<p>In this notebook, we were able to create a two-part recommender system using Tensorflow V2. Modern recommender systems commonly adopt a two-step approach to making recommendations. The first step involves retrieving items that a particular query (user) will enjoy. The second step involves ranking this items and returning the ranked list to the user.</p>
<p>There exists plenty room to expand our model from here. TensorFlow offers a vast amount of API’s for further expansion of recommender systems. In the grand scheme of things, this system is still considered quite trivial despite making strong recommendations. In our next notebook, we will attempt to incorporate some extra features into our recommendation system, such as genre tags as well as timestamps for when these genres were applied.</p>
</div>
</div>
<span id="document-Advanced_Deep_Learning_Recommender_System"></span><div class="section" id="advanced-deep-learning-recommender-system">
<h2>Advanced Deep Learning Recommender System<a class="headerlink" href="#advanced-deep-learning-recommender-system" title="Permalink to this headline">¶</a></h2>
<p>In the following notebook, we will be creating another Deep-Learning Recommender using Tensorflow V2. For this iteration, we will try to incorporate text and timestamp data available to us. As already stated multiple times, the tags in this data are user-generated. Therefore, they are messy, inconsistent, and may not be entirely accurate and or useful.</p>
<p>The TFRS package is incredibly robust, and offers plenty of direction for expansion of recommender systems. The library can tokenize text and timestamps into features. It processes text into a ‘bag-of-words’ representation, which it can then use to find similarities. It will be interesting to see if this approach alters recommendations to be affected more by the genre or tags associated with artists.</p>
<p>Similarly, it will be interesting to see how the inclusion of temporal data changes recommendations. In our data, a timestamp is associated with a <em>user</em>, <em>artist</em>, and <em>tag</em>. It indicates the exact time that particular user gave that artist that tag. It is entirely possible that amongst the tag information users who do not like particular artists have left negative tags. I wonder if an association will be made between few listens (<em>low weight</em>) and particular tag tokens.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">tempfile</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Text</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow_recommenders</span> <span class="k">as</span> <span class="nn">tfrs</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="accounting-for-tag-information">
<h3>Accounting for Tag Information<a class="headerlink" href="#accounting-for-tag-information" title="Permalink to this headline">¶</a></h3>
<p>In the following cell, we will prove that in our data, users can tag the same artist multiple times. Preferably, we would like only 1 tag for any user-artist association. We will order a user-artist tags dataset by their creation time and use the most recent tag and timestamp for each user-artist combination.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Let&#39;s read in genres and tags</span>
<span class="n">tags</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/tags.dat&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
<span class="n">user_tagging</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/user_taggedartists.dat&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
<span class="n">user_tagging_time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/user_taggedartists-timestamps.dat&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>

<span class="c1">#Check if duplicates are present</span>
<span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">user_tagging_time</span><span class="p">[[</span><span class="s1">&#39;userID&#39;</span><span class="p">,</span> <span class="s1">&#39;artistID&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">duplicated</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Contains Duplicate user-artist combinations.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Contains Duplicate user-artist combinations.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">u_tag_a</span> <span class="o">=</span> <span class="n">user_tagging</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tags</span><span class="p">[[</span><span class="s1">&#39;tagID&#39;</span><span class="p">,</span> <span class="s1">&#39;tagValue&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;tagID&#39;</span><span class="p">)</span>
<span class="n">u_tag_a</span> <span class="o">=</span> <span class="n">u_tag_a</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">user_tagging_time</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;userID&#39;</span><span class="p">,</span> <span class="s1">&#39;artistID&#39;</span><span class="p">,</span> <span class="s1">&#39;tagID&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Displaying 3 random samples for tag data:&quot;</span><span class="p">)</span>
<span class="n">u_tag_a</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Displaying 3 random samples for tag data:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>userID</th>
      <th>artistID</th>
      <th>tagID</th>
      <th>day</th>
      <th>month</th>
      <th>year</th>
      <th>tagValue</th>
      <th>timestamp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>45368</th>
      <td>791</td>
      <td>13415</td>
      <td>72</td>
      <td>1</td>
      <td>1</td>
      <td>2009</td>
      <td>hard rock</td>
      <td>1230764400000</td>
    </tr>
    <tr>
      <th>118264</th>
      <td>364</td>
      <td>7414</td>
      <td>537</td>
      <td>1</td>
      <td>4</td>
      <td>2008</td>
      <td>neofolk</td>
      <td>1207000800000</td>
    </tr>
    <tr>
      <th>10291</th>
      <td>47</td>
      <td>4915</td>
      <td>39</td>
      <td>1</td>
      <td>8</td>
      <td>2010</td>
      <td>dance</td>
      <td>1280613600000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Group by user-artist combo, sort by timestamp and extract that tagValue</span>
<span class="n">u_tag_a</span> <span class="o">=</span> <span class="n">u_tag_a</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;userID&#39;</span><span class="p">,</span> <span class="s1">&#39;artistID&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Let&#39;s check if this dataset contains duplicate user-artist combinations</span>
<span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">u_tag_a</span><span class="p">[[</span><span class="s1">&#39;userID&#39;</span><span class="p">,</span> <span class="s1">&#39;artistID&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Contains Duplicate user-artist combinations.&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Does not contain Duplicate user-artist combinations.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Does not contain Duplicate user-artist combinations.
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="data-preprocessing">
<h3>Data Preprocessing<a class="headerlink" href="#data-preprocessing" title="Permalink to this headline">¶</a></h3>
<p>Our preprocessing steps are as before for the most part. For a final step, we will merge our tag information dataset with our ratings matrix. To start, we normalise our weight column as previous.</p>
<p>There will be many cases where a user listens to a particular artist, but never provides that artist with a tag. In those cases, we will let the tag value be <code class="docutils literal notranslate"><span class="pre">no</span> <span class="pre">tag</span></code>, and for the corresponding timestamp value, we will use a value corresponding to today. We obviously want our model to find associations between users and common tags. However, our model can also build associations in situations where a user has decided to not provide a tag.</p>
<p>The timestamps provided in the dataset do not correspond to the correct year and must have the final 3 digits removed. For this, we can just divide them all by 1,000. Using <a class="reference external" href="https://timestamp.online/">this website</a>, I entered some of the corrected timestamps to ensure they do indeed correspond to the appropriate year. All entries I checked returned values around 2008 to 2011, which makes sense for this dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="c1">#Correct timestamp data in u_tag_a</span>
<span class="n">u_tag_a</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_tag_a</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Let&#39;s define our amount of users</span>
<span class="n">rating_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/user_artists.dat&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
<span class="n">num_users</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rating_matrix</span><span class="o">.</span><span class="n">userID</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Let&#39;s normalise our weight column per user</span>
<span class="n">new_rating_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;userID&#39;</span><span class="p">,</span> <span class="s1">&#39;artistID&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="n">rating_matrix</span><span class="o">.</span><span class="n">userID</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
    <span class="n">user_ratings</span> <span class="o">=</span> <span class="n">rating_matrix</span><span class="p">[</span><span class="n">rating_matrix</span><span class="o">.</span><span class="n">userID</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">]</span>
    <span class="n">ratings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">user_ratings</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">])</span>
    <span class="n">user_ratings</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">new_rating_matrix</span> <span class="o">=</span> <span class="n">new_rating_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_ratings</span><span class="p">)</span>
<span class="n">rating_matrix</span> <span class="o">=</span> <span class="n">new_rating_matrix</span>
<span class="n">rating_matrix</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\seanc\AppData\Local\Temp/ipykernel_9228/1239368141.py:6: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  user_ratings[&#39;weight&#39;] = tf.keras.utils.normalize(ratings, axis=-1, order=2)[0]
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>weight</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>92834.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>0.091235</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.109804</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000008</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>0.030397</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>0.062543</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>0.109109</td>
    </tr>
    <tr>
      <th>max</th>
      <td>1.000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Let&#39;s use left merge to merge our tag data and rating matrix</span>
<span class="n">rating_matrix</span> <span class="o">=</span> <span class="n">rating_matrix</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">u_tag_a</span><span class="p">[[</span><span class="s1">&#39;userID&#39;</span><span class="p">,</span> <span class="s1">&#39;artistID&#39;</span><span class="p">,</span> <span class="s1">&#39;tagValue&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">]],</span>
                                    <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;userID&#39;</span><span class="p">,</span> <span class="s1">&#39;artistID&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

<span class="c1">#Get today&#39;s timestamp</span>
<span class="n">now</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

<span class="c1">#Fill missing values as stated</span>
<span class="n">rating_matrix</span><span class="o">.</span><span class="n">tagValue</span> <span class="o">=</span> <span class="n">rating_matrix</span><span class="p">[</span><span class="s1">&#39;tagValue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;no tag&#39;</span><span class="p">)</span>
<span class="n">rating_matrix</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">rating_matrix</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Displaying Sample of new Rating Matrix&quot;</span><span class="p">)</span>
<span class="n">rating_matrix</span><span class="p">[</span><span class="n">rating_matrix</span><span class="o">.</span><span class="n">tagValue</span> <span class="o">!=</span> <span class="s1">&#39;no tag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Displaying Sample of new Rating Matrix
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>userID</th>
      <th>artistID</th>
      <th>weight</th>
      <th>tagValue</th>
      <th>timestamp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>58288</th>
      <td>1304</td>
      <td>646</td>
      <td>0.375415</td>
      <td>good</td>
      <td>1.304615e+12</td>
    </tr>
    <tr>
      <th>42008</th>
      <td>927</td>
      <td>233</td>
      <td>0.347750</td>
      <td>rock</td>
      <td>1.196464e+12</td>
    </tr>
    <tr>
      <th>20243</th>
      <td>439</td>
      <td>6619</td>
      <td>0.164645</td>
      <td>favorite</td>
      <td>1.293836e+12</td>
    </tr>
    <tr>
      <th>9434</th>
      <td>203</td>
      <td>4170</td>
      <td>0.078750</td>
      <td>metalcore</td>
      <td>1.262300e+12</td>
    </tr>
    <tr>
      <th>33323</th>
      <td>725</td>
      <td>9565</td>
      <td>0.016109</td>
      <td>conservative</td>
      <td>1.243807e+12</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The small sample above gives an indication for some of the values we can expect to find for tags. There is a large amount of distinct values in our tag data. It will be interesting to see how the recommender system interprets these.</p>
<p>The below pre-processing steps are as before in our other notebooks. We are correcting the scale of user and artist ID’s, then ensuring their maximum values are appropriate before replacing the columns in our rating matrix.</p>
</div>
<hr class="docutils" />
<div class="section" id="artist-preprocessing">
<h3>Artist Preprocessing<a class="headerlink" href="#artist-preprocessing" title="Permalink to this headline">¶</a></h3>
<p>To make use of the tags generally associated with artists, we will calculate their most popular tag in our data. We will use this information later on when developing our candidate model. The function in the cell below performs as previous. Essentially, it finds the most popular tag for each artist and attaches it to their profile.</p>
<p>We will add this extra information to our ratings matrix, as well as the artists name. Using the artist name as an identifier will make more sense to us than an ID number.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Let&#39;s match artists to genres</span>
<span class="n">artists</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/artists.dat&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
<span class="n">artists_tagged</span> <span class="o">=</span> <span class="n">user_tagging</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tags</span><span class="p">[[</span><span class="s1">&#39;tagID&#39;</span><span class="p">,</span> <span class="s1">&#39;tagValue&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;tagID&#39;</span><span class="p">)</span>
<span class="n">artists_tagged</span> <span class="o">=</span> <span class="p">(</span><span class="n">artists_tagged</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;artistID&#39;</span><span class="p">)[</span><span class="s1">&#39;tagValue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">grp</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">grp</span><span class="p">)))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="c1">#This function performs as previous.</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">artists_tagged</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">new_tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">tagValue</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">&gt;=</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">new_tags</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">])</span>
    <span class="n">new_tags</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">new_tags</span><span class="p">:</span>
        <span class="n">artists_tagged</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;tagValue&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">new_tags</span><span class="p">]</span>
        <span class="n">artists_tagged</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;genre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">artists_tagged</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;tagValue&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        
<span class="c1">#Let&#39;s add these tags to our artists</span>
<span class="n">artists</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="s1">&#39;artistID&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">artists</span> <span class="o">=</span> <span class="n">artists</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">artists_tagged</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;artistID&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">rsuffix</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
<span class="n">artists</span><span class="o">.</span><span class="n">tagValue</span> <span class="o">=</span> <span class="n">artists</span><span class="o">.</span><span class="n">tagValue</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;No Tags&#39;</span><span class="p">)</span>
<span class="n">artists</span><span class="o">.</span><span class="n">genre</span> <span class="o">=</span> <span class="n">artists</span><span class="o">.</span><span class="n">genre</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;No Tags&#39;</span><span class="p">)</span>
<span class="n">artists</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;tagValue&#39;</span><span class="p">:</span> <span class="s1">&#39;genres&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#We add the extra info to our ratings matrix</span>
<span class="n">rating_matrix</span> <span class="o">=</span> <span class="n">rating_matrix</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">artists</span><span class="p">[[</span><span class="s1">&#39;artistID&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;genre&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;artistID&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Extract userID column</span>
<span class="n">userids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rating_matrix</span><span class="o">.</span><span class="n">userID</span><span class="p">)</span>

<span class="c1">#Remap the column</span>
<span class="n">u_mapper</span><span class="p">,</span> <span class="n">u_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">userids</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">#Let&#39;s define our amount of artists</span>
<span class="n">artists</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/artists.dat&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
<span class="n">artists</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="s1">&#39;artistID&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">num_artists</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">artists</span><span class="o">.</span><span class="n">artistID</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="c1">#Extract artistID column</span>
<span class="n">artistids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rating_matrix</span><span class="o">.</span><span class="n">artistID</span><span class="p">)</span>

<span class="c1">#Remap the column</span>
<span class="n">a_mapper</span><span class="p">,</span> <span class="n">a_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">artistids</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s replace old columns with new ind ones</span>
<span class="n">rating_matrix</span><span class="o">.</span><span class="n">userID</span> <span class="o">=</span> <span class="n">u_ind</span>
<span class="n">rating_matrix</span><span class="o">.</span><span class="n">artistID</span> <span class="o">=</span> <span class="n">a_ind</span>

<span class="c1">#Let&#39;s ensure the max value is approriate</span>
<span class="k">assert</span><span class="p">(</span><span class="n">rating_matrix</span><span class="o">.</span><span class="n">userID</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1891</span><span class="p">)</span>
<span class="k">assert</span><span class="p">(</span><span class="n">rating_matrix</span><span class="o">.</span><span class="n">artistID</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">17631</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#We convert the ID&#39;s to string so we can use the StringLookup function later</span>
<span class="n">rating_matrix</span><span class="o">.</span><span class="n">userID</span> <span class="o">=</span> <span class="n">rating_matrix</span><span class="o">.</span><span class="n">userID</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">rating_matrix</span><span class="o">.</span><span class="n">artistID</span> <span class="o">=</span> <span class="n">rating_matrix</span><span class="o">.</span><span class="n">artistID</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<span class="n">rating_matrix</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">rating_matrix</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rating_matrix</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>userID</th>
      <th>artistID</th>
      <th>weight</th>
      <th>tagValue</th>
      <th>timestamp</th>
      <th>name</th>
      <th>genre</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>66177</th>
      <td>913</td>
      <td>3601</td>
      <td>0.085014</td>
      <td>dance</td>
      <td>1167606000000</td>
      <td>Girl Talk</td>
      <td>alternative</td>
    </tr>
    <tr>
      <th>10551</th>
      <td>1328</td>
      <td>225</td>
      <td>0.160945</td>
      <td>no tag</td>
      <td>1638620584</td>
      <td>Devendra Banhart</td>
      <td>No Tags</td>
    </tr>
    <tr>
      <th>60881</th>
      <td>799</td>
      <td>2751</td>
      <td>0.072099</td>
      <td>post-rock</td>
      <td>1233442800000</td>
      <td>Russian Circles</td>
      <td>No Tags</td>
    </tr>
    <tr>
      <th>41799</th>
      <td>225</td>
      <td>1035</td>
      <td>0.053948</td>
      <td>no tag</td>
      <td>1638620584</td>
      <td>Slipknot</td>
      <td>j-rock</td>
    </tr>
    <tr>
      <th>86831</th>
      <td>1081</td>
      <td>12514</td>
      <td>0.039889</td>
      <td>indie</td>
      <td>1296514800000</td>
      <td>Anna Calvi</td>
      <td>No Tags</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="model-development">
<h3>Model Development<a class="headerlink" href="#model-development" title="Permalink to this headline">¶</a></h3>
<p>We will perform the steps to developing a model as previous. However, we will now utilise our tags and timestamps. We do this by instantiating our interactions dictionary and including the extra features.</p>
<div class="section" id="instantiate-interaction-dictionary">
<h4>Instantiate Interaction Dictionary<a class="headerlink" href="#instantiate-interaction-dictionary" title="Permalink to this headline">¶</a></h4>
<p>Our interactions dictionary is just our rating matrix. It contains the following features <code class="docutils literal notranslate"><span class="pre">userID</span></code>, <code class="docutils literal notranslate"><span class="pre">artistID</span></code>, <code class="docutils literal notranslate"><span class="pre">name</span></code>, <code class="docutils literal notranslate"><span class="pre">weight</span></code>, <code class="docutils literal notranslate"><span class="pre">tag</span></code>, <code class="docutils literal notranslate"><span class="pre">genre</span></code>, and <code class="docutils literal notranslate"><span class="pre">timestamp</span></code>. We create a mapping for our dictionary below. We also create seperate individual mappings for artist ID’s, tags, and genres.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Let&#39;s build our interactions dictionary as previous</span>
<span class="n">interactions_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">rating_matrix</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">interactions</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">interactions_dict</span><span class="p">)</span>

<span class="n">items_dict</span> <span class="o">=</span> <span class="n">rating_matrix</span><span class="p">[[</span><span class="s1">&#39;artistID&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
<span class="n">items_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">items_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">items</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">items_dict</span><span class="p">)</span>

<span class="n">names_dict</span> <span class="o">=</span> <span class="n">rating_matrix</span><span class="p">[[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
<span class="n">names_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">names_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">names</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">names_dict</span><span class="p">)</span>

<span class="n">tags_dict</span> <span class="o">=</span> <span class="n">rating_matrix</span><span class="p">[[</span><span class="s1">&#39;tagValue&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
<span class="n">tags_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">tags_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">tags</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">tags_dict</span><span class="p">)</span>

<span class="n">genre_dict</span> <span class="o">=</span> <span class="n">rating_matrix</span><span class="p">[[</span><span class="s1">&#39;genre&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
<span class="n">genre_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">genre_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">genres</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">genre_dict</span><span class="p">)</span>

<span class="n">interactions</span> <span class="o">=</span> <span class="n">interactions</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">{</span>
                                            <span class="s1">&#39;userID&#39;</span> <span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;userID&#39;</span><span class="p">],</span> 
                                            <span class="s1">&#39;artistID&#39;</span> <span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;artistID&#39;</span><span class="p">],</span> 
                                            <span class="s1">&#39;name&#39;</span> <span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                                            <span class="s1">&#39;weight&#39;</span> <span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]),</span>
                                            <span class="s1">&#39;tag&#39;</span> <span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;tagValue&#39;</span><span class="p">],</span>
                                            <span class="s1">&#39;genre&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;genre&#39;</span><span class="p">],</span>
                                            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">],})</span>

<span class="c1">#artists = names.map(lambda x: x[&#39;name&#39;])</span>
<span class="n">items</span> <span class="o">=</span> <span class="n">items</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;artistID&#39;</span><span class="p">])</span>
<span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;tagValue&#39;</span><span class="p">])</span>
<span class="n">genres</span> <span class="o">=</span> <span class="n">genres</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;genre&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="timestamp-normalisation">
<h4>Timestamp Normalisation<a class="headerlink" href="#timestamp-normalisation" title="Permalink to this headline">¶</a></h4>
<p>As timestamps are represented as large integers, they are not healthy to use as direct input into our model. We firstly normalise our timestamps by calculaitng our minimum and maximum timestamp, then creating buckets at equal intervals between these two times. We instantiate 1000 buckets which are used to host our timestamps.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Let&#39;s create bins for our timestamps</span>
<span class="n">max_timestamp</span> <span class="o">=</span> <span class="n">interactions</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="n">min_timestamp</span> <span class="o">=</span> <span class="n">interactions</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="mf">1e9</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">minimum</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

<span class="n">timestamp_buckets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span> <span class="n">min_timestamp</span><span class="p">,</span> <span class="n">max_timestamp</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">1000</span><span class="p">,)</span>

<span class="n">timestamps</span> <span class="o">=</span> <span class="n">interactions</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="lookup-tables-training-test-data-split">
<h4>Lookup Tables &amp; Training, Test Data Split<a class="headerlink" href="#lookup-tables-training-test-data-split" title="Permalink to this headline">¶</a></h4>
<p>In the following cell, we define various lookup tables which we may use later on. We also shuffle our data and create testing and training batches which will be fed into our model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### get unique item and user id&#39;s as a lookup table</span>
<span class="n">unique_artist_ids</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">a_ind</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">unique_user_ids</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">u_ind</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">unique_genre_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">rating_matrix</span><span class="o">.</span><span class="n">genre</span><span class="p">)</span>
<span class="n">unique_user_tags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">rating_matrix</span><span class="o">.</span><span class="n">tagValue</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Randomly shuffle data and split between train and test.</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">shuffled</span> <span class="o">=</span> <span class="n">interactions</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="mi">100_000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">reshuffle_each_iteration</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">train</span> <span class="o">=</span> <span class="n">shuffled</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">62_000</span><span class="p">)</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">shuffled</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="mi">62_000</span><span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">30_000</span><span class="p">)</span>

<span class="n">cached_train</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="mi">62_000</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">5_000</span><span class="p">)</span>
<span class="n">cached_test</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">2_500</span><span class="p">)</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;our test set is: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;our train set is: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>our test set is: 62000
our train set is: 30000
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="model-creation">
<h3>Model Creation<a class="headerlink" href="#model-creation" title="Permalink to this headline">¶</a></h3>
<p>The below cells host a more complex version of the model we saw previously. In our previous model, we simply instantiated our user and item embeddings as we would in a regular collaborative filtering model. In this instance, we further develop our user and item models.</p>
<hr class="docutils" />
<div class="section" id="user-model">
<h4>User Model<a class="headerlink" href="#user-model" title="Permalink to this headline">¶</a></h4>
<p>In the below cell, we develop our user model. We incorporate the user ID, as well as the timestamp data. As the timestamp data signifies when a user provided a tag to an artist, it is more suitably found in the user model.</p>
<p>In our user model, we have included a parameter, <code class="docutils literal notranslate"><span class="pre">_use_timestamps</span></code>. When set to true, the model incorporates time stamp information. This will allow us to compare the results of the model with, or without the use of timestamps.</p>
<p>In our dataset, it’s hard to interpret the utility of timestamps. This is because timestamp information is related to when the user-provided tags were actually applied to the artist, rather than when the user posted the tag. Also, there is an argument that including timestamps of today’s date may have negative effects on the model. This model is trained on information from 2009 to 2011, essentially making it a model of that period. Timestamps from today allow the model to ‘see into the future’, which is obviously not a realistic trait of ML models.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### user model</span>

<span class="k">class</span> <span class="nc">UserModel</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_timestamps</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">max_tokes</span><span class="o">=</span><span class="mi">25_000</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_use_timestamps</span> <span class="o">=</span> <span class="n">use_timestamps</span>

        <span class="c1">## embed user id from unique_user_ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_embedding</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">StringLookup</span><span class="p">(</span>
                <span class="n">vocabulary</span><span class="o">=</span><span class="n">unique_user_ids</span><span class="p">),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_user_ids</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
        <span class="p">])</span>
        
        <span class="c1">## embed timestamp</span>
        <span class="k">if</span> <span class="n">use_timestamps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timestamp_embedding</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
              <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">Discretization</span><span class="p">(</span><span class="n">timestamp_buckets</span><span class="o">.</span><span class="n">tolist</span><span class="p">()),</span>
              <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timestamp_buckets</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
            <span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalized_timestamp</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">Normalization</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalized_timestamp</span><span class="o">.</span><span class="n">adapt</span><span class="p">(</span><span class="n">timestamps</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_timestamps</span><span class="p">:</span>
              <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_embedding</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;userID&quot;</span><span class="p">])</span>

        <span class="c1">## all features here</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_embedding</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;userID&quot;</span><span class="p">]),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timestamp_embedding</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalized_timestamp</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
        <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="item-model">
<h4>Item Model<a class="headerlink" href="#item-model" title="Permalink to this headline">¶</a></h4>
<p>Our item model incorporates our artist ID as before. However, it also makes use of the genre associated with the artist.</p>
<p>To make use of genre strings, we must first instantiate our <code class="docutils literal notranslate"><span class="pre">genre_vectorizer</span></code>. This will allow us to convert our genre string into a numerical representation. The <code class="docutils literal notranslate"><span class="pre">genre_vectorizer</span></code> is then used by our <code class="docutils literal notranslate"><span class="pre">genre_text_embedding</span></code> processing step to create an embedding of this word vector. Word embeddings allow us to measure similarity between text.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### candidate model</span>

<span class="k">class</span> <span class="nc">ItemModel</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">max_tokens</span> <span class="o">=</span> <span class="mi">10_000</span>
        
        <span class="c1">## embed artist id from unique_artist_ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">artist_embedding</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">StringLookup</span><span class="p">(</span>
                <span class="n">vocabulary</span><span class="o">=</span><span class="n">unique_artist_ids</span><span class="p">),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_artist_ids</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">),])</span>
        
        <span class="c1">## processing text features: item genre vectorizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">artist_vectorizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">TextVectorization</span><span class="p">(</span>
            <span class="n">max_tokens</span><span class="o">=</span><span class="n">max_tokens</span><span class="p">)</span>

        <span class="c1">## we apply genre vectorizer to genres</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">artist_text_embedding</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">artist_vectorizer</span><span class="p">,</span>
                              <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">max_tokens</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">mask_zero</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                              <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">GlobalAveragePooling1D</span><span class="p">(),])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">artist_vectorizer</span><span class="o">.</span><span class="n">adapt</span><span class="p">(</span><span class="n">genres</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">artist_embedding</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;artistID&quot;</span><span class="p">]),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">artist_text_embedding</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;genre&quot;</span><span class="p">]),],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="combining-models">
<h4>Combining Models<a class="headerlink" href="#combining-models" title="Permalink to this headline">¶</a></h4>
<p>The following cell is our parent model which we use to combine the output of both our User and Item models. We feed the outputs of each model into two dense embedding layers both of the same shape (<em>32</em>).</p>
<p>We then define our task (in this case FactorizedTopK), then compute the loss as we did previously.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MusicModel</span><span class="p">(</span><span class="n">tfrs</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_timestamps</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1">## query model is user model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
                          <span class="n">UserModel</span><span class="p">(</span><span class="n">use_timestamps</span><span class="p">),</span>
                          <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">)])</span>
        
        <span class="c1">## candidate model is the item model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">candidate_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
                              <span class="n">ItemModel</span><span class="p">(),</span>
                              <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">)])</span>
        
        <span class="c1">## retrieval task, choose metrics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">tfrs</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">Retrieval</span><span class="p">(</span>
                    <span class="n">metrics</span><span class="o">=</span><span class="n">tfrs</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">FactorizedTopK</span><span class="p">(</span>
                        <span class="n">candidates</span><span class="o">=</span><span class="n">items</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">candidate_model</span><span class="p">),),)</span>

    <span class="k">def</span> <span class="nf">compute_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># We only pass the user id and timestamp features into the query model. This</span>
        <span class="c1"># is to ensure that the training inputs would have the same keys as the</span>
        <span class="c1"># query inputs. Otherwise the discrepancy in input structure would cause an</span>
        <span class="c1"># error when loading the query model after saving it.</span>
        
        <span class="n">query_embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_model</span><span class="p">({</span> <span class="s2">&quot;userID&quot;</span><span class="p">:</span> <span class="n">features</span><span class="p">[</span><span class="s2">&quot;userID&quot;</span><span class="p">],</span>
                                               <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">features</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">],</span>
                                                <span class="s2">&quot;tag&quot;</span><span class="p">:</span> <span class="n">features</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">],</span>
                                            <span class="p">})</span>
        
        <span class="n">item_embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">candidate_model</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;genre&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">query_embeddings</span><span class="p">,</span> <span class="n">item_embeddings</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="model-fitting-and-evaluation">
<h4>Model Fitting and Evaluation<a class="headerlink" href="#model-fitting-and-evaluation" title="Permalink to this headline">¶</a></h4>
<p>In the following cells, we will perform two different fitting and evaluation scenarios: <span class="math notranslate nohighlight">\((a)\)</span> <code class="docutils literal notranslate"><span class="pre">_use_timestamps</span> <span class="pre">=</span> <span class="pre">True</span></code>, and <span class="math notranslate nohighlight">\((b)\)</span> <code class="docutils literal notranslate"><span class="pre">_use_timestamps</span> <span class="pre">=</span> <span class="pre">False</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">MusicModel</span><span class="p">(</span><span class="n">use_timestamps</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adagrad</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cached_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">cached_test</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span>---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
~\AppData\Local\Temp/ipykernel_9228/2711739428.py in &lt;module&gt;
----&gt; 1 model = MusicModel(use_timestamps=False)
      2 model.compile(optimizer=tf.keras.optimizers.Adagrad(0.1))
      3 model.fit(cached_train, epochs=3)
      4 model.evaluate(cached_test, return_dict=True)

~\AppData\Local\Temp/ipykernel_9228/2758195486.py in __init__(self, use_timestamps)
     16         self.task = tfrs.tasks.Retrieval(
     17                     metrics=tfrs.metrics.FactorizedTopK(
---&gt; 18                         candidates=items.batch(128).map(self.candidate_model),),)
     19 
     20     def compute_loss(self, features, training=False):

~\AppData\Roaming\Python\Python38\site-packages\tensorflow\python\data\ops\dataset_ops.py in map(self, map_func, num_parallel_calls, deterministic, name)
   2002         warnings.warn(&quot;The `deterministic` argument has no effect unless the &quot;
   2003                       &quot;`num_parallel_calls` argument is specified.&quot;)
-&gt; 2004       return MapDataset(self, map_func, preserve_cardinality=True, name=name)
   2005     else:
   2006       return ParallelMapDataset(

~\AppData\Roaming\Python\Python38\site-packages\tensorflow\python\data\ops\dataset_ops.py in __init__(self, input_dataset, map_func, use_inter_op_parallelism, preserve_cardinality, use_legacy_function, name)
   5453     self._use_inter_op_parallelism = use_inter_op_parallelism
   5454     self._preserve_cardinality = preserve_cardinality
-&gt; 5455     self._map_func = StructuredFunctionWrapper(
   5456         map_func,
   5457         self._transformation_name(),

~\AppData\Roaming\Python\Python38\site-packages\tensorflow\python\data\ops\dataset_ops.py in __init__(self, func, transformation_name, dataset, input_classes, input_shapes, input_types, input_structure, add_to_graph, use_legacy_function, defun_kwargs)
   4531         fn_factory = trace_tf_function(defun_kwargs)
   4532 
-&gt; 4533     self._function = fn_factory()
   4534     # There is no graph to add in eager mode.
   4535     add_to_graph &amp;= not context.executing_eagerly()

~\AppData\Roaming\Python\Python38\site-packages\tensorflow\python\eager\function.py in get_concrete_function(self, *args, **kwargs)
   3242          or `tf.Tensor` or `tf.TensorSpec`.
   3243     &quot;&quot;&quot;
-&gt; 3244     graph_function = self._get_concrete_function_garbage_collected(
   3245         *args, **kwargs)
   3246     graph_function._garbage_collector.release()  # pylint: disable=protected-access

~\AppData\Roaming\Python\Python38\site-packages\tensorflow\python\eager\function.py in _get_concrete_function_garbage_collected(self, *args, **kwargs)
   3208       args, kwargs = None, None
   3209     with self._lock:
-&gt; 3210       graph_function, _ = self._maybe_define_function(args, kwargs)
   3211       seen_names = set()
   3212       captured = object_identity.ObjectIdentitySet(

~\AppData\Roaming\Python\Python38\site-packages\tensorflow\python\eager\function.py in _maybe_define_function(self, args, kwargs)
   3555 
   3556           self._function_cache.missed.add(call_context_key)
-&gt; 3557           graph_function = self._create_graph_function(args, kwargs)
   3558           self._function_cache.primary[cache_key] = graph_function
   3559 

~\AppData\Roaming\Python\Python38\site-packages\tensorflow\python\eager\function.py in _create_graph_function(self, args, kwargs, override_flat_arg_shapes)
   3390     arg_names = base_arg_names + missing_arg_names
   3391     graph_function = ConcreteFunction(
-&gt; 3392         func_graph_module.func_graph_from_py_func(
   3393             self._name,
   3394             self._python_function,

~\AppData\Roaming\Python\Python38\site-packages\tensorflow\python\framework\func_graph.py in func_graph_from_py_func(name, python_func, args, kwargs, signature, func_graph, autograph, autograph_options, add_control_dependencies, arg_names, op_return_value, collections, capture_by_value, override_flat_arg_shapes, acd_record_initial_resource_uses)
   1141         _, original_func = tf_decorator.unwrap(python_func)
   1142 
-&gt; 1143       func_outputs = python_func(*func_args, **func_kwargs)
   1144 
   1145       # invariant: `func_outputs` contains only Tensors, CompositeTensors,

~\AppData\Roaming\Python\Python38\site-packages\tensorflow\python\data\ops\dataset_ops.py in wrapped_fn(*args)
   4508           attributes=defun_kwargs)
   4509       def wrapped_fn(*args):  # pylint: disable=missing-docstring
-&gt; 4510         ret = wrapper_helper(*args)
   4511         ret = structure.to_tensor_list(self._output_structure, ret)
   4512         return [ops.convert_to_tensor(t) for t in ret]

~\AppData\Roaming\Python\Python38\site-packages\tensorflow\python\data\ops\dataset_ops.py in wrapper_helper(*args)
   4438       if not _should_unpack(nested_args):
   4439         nested_args = (nested_args,)
-&gt; 4440       ret = autograph.tf_convert(self._func, ag_ctx)(*nested_args)
   4441       if _should_pack(ret):
   4442         ret = tuple(ret)

~\AppData\Roaming\Python\Python38\site-packages\tensorflow\python\autograph\impl\api.py in wrapper(*args, **kwargs)
    694       try:
    695         with conversion_ctx:
--&gt; 696           return converted_call(f, args, kwargs, options=options)
    697       except Exception as e:  # pylint:disable=broad-except
    698         if hasattr(e, &#39;ag_error_metadata&#39;):

~\AppData\Roaming\Python\Python38\site-packages\tensorflow\python\autograph\impl\api.py in converted_call(f, args, kwargs, caller_fn_scope, options)
    381 
    382   if not options.user_requested and conversion.is_allowlisted(f):
--&gt; 383     return _call_unconverted(f, args, kwargs, options)
    384 
    385   # internal_convert_user_code is for example turned off when issuing a dynamic

~\AppData\Roaming\Python\Python38\site-packages\tensorflow\python\autograph\impl\api.py in _call_unconverted(f, args, kwargs, options, update_cache)
    462 
    463   if kwargs is not None:
--&gt; 464     return f(*args, **kwargs)
    465   return f(*args)
    466 

~\AppData\Roaming\Python\Python38\site-packages\keras\utils\traceback_utils.py in error_handler(*args, **kwargs)
     65     except Exception as e:  # pylint: disable=broad-except
     66       filtered_tb = _process_traceback_frames(e.__traceback__)
---&gt; 67       raise e.with_traceback(filtered_tb) from None
     68     finally:
     69       del filtered_tb

~\AppData\Roaming\Python\Python38\site-packages\tensorflow\python\autograph\impl\api.py in wrapper(*args, **kwargs)
    697       except Exception as e:  # pylint:disable=broad-except
    698         if hasattr(e, &#39;ag_error_metadata&#39;):
--&gt; 699           raise e.ag_error_metadata.to_exception(e)
    700         else:
    701           raise

TypeError: Exception encountered when calling layer &quot;item_model&quot; (type ItemModel).

in user code:

    File &quot;C:\Users\seanc\AppData\Local\Temp/ipykernel_9228/3669663950.py&quot;, line 30, in call  *
        self.artist_text_embedding(inputs[&quot;genre&quot;]),], axis=1)

    TypeError: Only integers, slices (`:`), ellipsis (`...`), tf.newaxis (`None`) and scalar tf.int32/tf.int64 tensors are valid indices, got &#39;artistID&#39;


Call arguments received:
  • inputs=tf.Tensor(shape=(None,), dtype=string)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">MusicModel</span><span class="p">(</span><span class="n">use_timestamps</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adagrad</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cached_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">cached_test</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/3
WARNING:tensorflow:Layers in a Sequential model should only have a single input tensor, but we receive a &lt;class &#39;dict&#39;&gt; input: {&#39;userID&#39;: &lt;tf.Tensor &#39;IteratorGetNext:5&#39; shape=(None,) dtype=string&gt;, &#39;timestamp&#39;: &lt;tf.Tensor &#39;IteratorGetNext:4&#39; shape=(None,) dtype=int64&gt;, &#39;tag&#39;: &lt;tf.Tensor &#39;IteratorGetNext:3&#39; shape=(None,) dtype=string&gt;}
Consider rewriting this model with the Functional API.
WARNING:tensorflow:Layers in a Sequential model should only have a single input tensor, but we receive a &lt;class &#39;dict&#39;&gt; input: {&#39;userID&#39;: &lt;tf.Tensor &#39;IteratorGetNext:5&#39; shape=(None,) dtype=string&gt;, &#39;timestamp&#39;: &lt;tf.Tensor &#39;IteratorGetNext:4&#39; shape=(None,) dtype=int64&gt;, &#39;tag&#39;: &lt;tf.Tensor &#39;IteratorGetNext:3&#39; shape=(None,) dtype=string&gt;}
Consider rewriting this model with the Functional API.
13/13 [==============================] - 62s 4s/step - factorized_top_k/top_1_categorical_accuracy: 0.2838 - factorized_top_k/top_5_categorical_accuracy: 0.3035 - factorized_top_k/top_10_categorical_accuracy: 0.3124 - factorized_top_k/top_50_categorical_accuracy: 0.3349 - factorized_top_k/top_100_categorical_accuracy: 0.3480 - loss: 39029.6232 - regularization_loss: 0.0000e+00 - total_loss: 39029.6232
Epoch 2/3
13/13 [==============================] - 60s 4s/step - factorized_top_k/top_1_categorical_accuracy: 0.3954 - factorized_top_k/top_5_categorical_accuracy: 0.4175 - factorized_top_k/top_10_categorical_accuracy: 0.4273 - factorized_top_k/top_50_categorical_accuracy: 0.4529 - factorized_top_k/top_100_categorical_accuracy: 0.4650 - loss: 38513.8764 - regularization_loss: 0.0000e+00 - total_loss: 38513.8764
Epoch 3/3
13/13 [==============================] - 63s 5s/step - factorized_top_k/top_1_categorical_accuracy: 0.5219 - factorized_top_k/top_5_categorical_accuracy: 0.5371 - factorized_top_k/top_10_categorical_accuracy: 0.5441 - factorized_top_k/top_50_categorical_accuracy: 0.5613 - factorized_top_k/top_100_categorical_accuracy: 0.5698 - loss: 38298.1392 - regularization_loss: 0.0000e+00 - total_loss: 38298.1392
WARNING:tensorflow:Layers in a Sequential model should only have a single input tensor, but we receive a &lt;class &#39;dict&#39;&gt; input: {&#39;userID&#39;: &lt;tf.Tensor &#39;IteratorGetNext:5&#39; shape=(None,) dtype=string&gt;, &#39;timestamp&#39;: &lt;tf.Tensor &#39;IteratorGetNext:4&#39; shape=(None,) dtype=int64&gt;, &#39;tag&#39;: &lt;tf.Tensor &#39;IteratorGetNext:3&#39; shape=(None,) dtype=string&gt;}
Consider rewriting this model with the Functional API.
12/12 [==============================] - 30s 2s/step - factorized_top_k/top_1_categorical_accuracy: 0.4899 - factorized_top_k/top_5_categorical_accuracy: 0.5035 - factorized_top_k/top_10_categorical_accuracy: 0.5103 - factorized_top_k/top_50_categorical_accuracy: 0.5257 - factorized_top_k/top_100_categorical_accuracy: 0.5324 - loss: 19461.5293 - regularization_loss: 0.0000e+00 - total_loss: 19461.5293
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;factorized_top_k/top_1_categorical_accuracy&#39;: 0.4898666739463806,
 &#39;factorized_top_k/top_5_categorical_accuracy&#39;: 0.5034999847412109,
 &#39;factorized_top_k/top_10_categorical_accuracy&#39;: 0.5102666616439819,
 &#39;factorized_top_k/top_50_categorical_accuracy&#39;: 0.5256999731063843,
 &#39;factorized_top_k/top_100_categorical_accuracy&#39;: 0.5324333310127258,
 &#39;loss&#39;: 19464.4296875,
 &#39;regularization_loss&#39;: 0,
 &#39;total_loss&#39;: 19464.4296875}
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="output-analysis">
<h4>Output Analysis<a class="headerlink" href="#output-analysis" title="Permalink to this headline">¶</a></h4>
<p>From the above output, it’s clear that timestamps do not improve recommendations for this model. This is likely due to the fact that a substantial amount of the timestamps are of today’s date which is throwing off the model. Perhaps a better data imputation would have been the median date observed in the data.</p>
<p>Otherwise both models seem to have reasonable performance with a positive item being returned as the top candidate 50% of the time. These models will supply a basis for our next advanced deep retrieval model.</p>
</div>
</div>
<div class="section" id="conclusions">
<h3>Conclusions<a class="headerlink" href="#conclusions" title="Permalink to this headline">¶</a></h3>
<p>In this notebook, we experimented with building a more complex deep learning framework by enhancing the input used in our query and item towers. Leveraging context features such as timestamps and text data can lead to better model performance and higher quality recommendations being produced.</p>
<p>However, we learned that proper imputation of data is an important aspect of data quality. Poorly imputated data can lead to contextual features having a negative effect on retrieval. In our case, it does not make sense to use today’s timestamp in our data, as this allows the model to essentially ‘see into the future’. This is an unrealisticquality of our model.</p>
<p>Although being more complex than our previos models, it still remains in its imfancy, and TFRS offers many directions to expand our model further. We will leave this for future work.</p>
</div>
</div>
<span id="document-conclusions"></span><div class="section" id="conclusions">
<h2>Conclusions<a class="headerlink" href="#conclusions" title="Permalink to this headline">¶</a></h2>
<p>The following research aimed to roughly follow the outline of previous innovation and advances in recommender systems while simultaneously producing varying recommender models built on top of the <a class="reference external" href="https://grouplens.org/datasets/hetrec-2011/">HETREC 2011</a> <span id="id1">[<a class="reference internal" href="intro.html#id3">Cantador <em>et al.</em>, 2011</a>]</span> 2nd International Workshop on Information Heterogeneity and Fusion in Recommender Systems <a class="reference external" href="https://www.last.fm/">Last.FM</a> dataset.</p>
<p>We began by incorporating a Matrix Factorisation model, which calculates the product between learned user and item embeddings to produce a score for that particular user-item combination. This type of model proved very intuitive, but lacks in some predictive power and tends to be biased towards recommending popular items.</p>
<p>We then moved on to developing deep learning recommender systems using Keras on top of Tensorflow, specifically using their TFRS package. This package makes development of recommender systems an easy and fluid process. We only scratched the surface of what is capable with this package. In the future, it would be interesting to explore the more complex offerings of TFRS with this relatively simple dataset.</p>
</div>
<span id="document-bibliography"></span><div class="section" id="bibliography">
<h2>Bibliography<a class="headerlink" href="#bibliography" title="Permalink to this headline">¶</a></h2>
<hr class="docutils" />
<p id="id1"><dl class="citation">
<dt class="label" id="id15"><span class="brackets">And06</span></dt>
<dd><p>Chris Anderson. <em>The long tail: Why the future of business is selling less of more</em>. Hachette Books, 2006.</p>
</dd>
<dt class="label" id="id4"><span class="brackets">BalabanovicS97</span></dt>
<dd><p>Marko Balabanović and Yoav Shoham. Fab: content-based, collaborative recommendation. <em>Commun. ACM</em>, 40(3):66–72, mar 1997. URL: <a class="reference external" href="https://doi.org/10.1145/245108.245124">https://doi.org/10.1145/245108.245124</a>, <a class="reference external" href="https://doi.org/10.1145/245108.245124">doi:10.1145/245108.245124</a>.</p>
</dd>
<dt class="label" id="id3"><span class="brackets">CBK11</span></dt>
<dd><p>Iván Cantador, Peter Brusilovsky, and Tsvi Kuflik. Second workshop on information heterogeneity and fusion in recommender systems (hetrec2011). In <em>Proceedings of the fifth ACM conference on Recommender systems</em>, 387–388. 2011.</p>
</dd>
<dt class="label" id="id17"><span class="brackets">CKH+16</span></dt>
<dd><p>Heng-Tze Cheng, Levent Koc, Jeremiah Harmsen, Tal Shaked, Tushar Chandra, Hrishi Aradhye, Glen Anderson, Greg Corrado, Wei Chai, Mustafa Ispir, Rohan Anil, Zakaria Haque, Lichan Hong, Vihan Jain, Xiaobing Liu, and Hemal Shah. Wide &amp;amp; deep learning for recommender systems. In <em>Proceedings of the 1st Workshop on Deep Learning for Recommender Systems</em>, DLRS 2016, 7–10. Association for Computing Machinery, Sep 2016. URL: <a class="reference external" href="https://doi.org/10.1145/2988450.2988454">https://doi.org/10.1145/2988450.2988454</a>, <a class="reference external" href="https://doi.org/10.1145/2988450.2988454">doi:10.1145/2988450.2988454</a>.</p>
</dd>
<dt class="label" id="id12"><span class="brackets">CZ07</span></dt>
<dd><p>Andrzej Cichocki and Rafal Zdunek. Regularized alternating least squares algorithms for non-negative matrix/tensor factorization. In Derong Liu, Shumin Fei, Zengguang Hou, Huaguang Zhang, and Changyin Sun, editors, <em>Advances in Neural Networks – ISNN 2007</em>, 793–802. Berlin, Heidelberg, 2007. Springer Berlin Heidelberg.</p>
</dd>
<dt class="label" id="id16"><span class="brackets">CAS16</span></dt>
<dd><p>Paul Covington, Jay Adams, and Emre Sargin. Deep neural networks for youtube recommendations. In <em>Proceedings of the 10th ACM Conference on Recommender Systems</em>, RecSys ’16, 191–198. Association for Computing Machinery, Sep 2016. URL: <a class="reference external" href="https://doi.org/10.1145/2959100.2959190">https://doi.org/10.1145/2959100.2959190</a>, <a class="reference external" href="https://doi.org/10.1145/2959100.2959190">doi:10.1145/2959100.2959190</a>.</p>
</dd>
<dt class="label" id="id2"><span class="brackets">ERK11</span></dt>
<dd><p>Michael D Ekstrand, John T Riedl, and Joseph A Konstan. <em>Collaborative filtering recommender systems</em>. Now Publishers Inc, 2011.</p>
</dd>
<dt class="label" id="id9"><span class="brackets">ERR16</span></dt>
<dd><p>Mehdi Elahi, Francesco Ricci, and Neil Rubens. A survey of active learning in collaborative filtering recommender systems. <em>Computer Science Review</em>, 20:29–50, 2016. <a class="reference external" href="https://doi.org/https://doi.org/10.1016/j.cosrev.2016.05.002">doi:https://doi.org/10.1016/j.cosrev.2016.05.002</a>.</p>
</dd>
<dt class="label" id="id13"><span class="brackets">GNHS11</span></dt>
<dd><p>Rainer Gemulla, Erik Nijkamp, Peter J. Haas, and Yannis Sismanis. Large-scale matrix factorization with distributed stochastic gradient descent. In <em>Proceedings of the 17th ACM SIGKDD International Conference on Knowledge Discovery and Data Mining</em>, KDD '11, 69–77. New York, NY, USA, 2011. Association for Computing Machinery. URL: <a class="reference external" href="https://doi.org/10.1145/2020408.2020426">https://doi.org/10.1145/2020408.2020426</a>, <a class="reference external" href="https://doi.org/10.1145/2020408.2020426">doi:10.1145/2020408.2020426</a>.</p>
</dd>
<dt class="label" id="id6"><span class="brackets">GMM98</span></dt>
<dd><p>Robert H Guttman, Alexandros G Moukas, and Pattie Maes. Agent-mediated electronic commerce: a survey. <em>The Knowledge Engineering Review</em>, 13(2):147–159, 1998.</p>
</dd>
<dt class="label" id="id11"><span class="brackets">KBV09</span></dt>
<dd><p>Yehuda Koren, Robert Bell, and Chris Volinsky. Matrix factorization techniques for recommender systems. <em>Computer</em>, 42(8):30–37, Aug 2009. <a class="reference external" href="https://doi.org/10.1109/MC.2009.263">doi:10.1109/MC.2009.263</a>.</p>
</dd>
<dt class="label" id="id10"><span class="brackets">LSPU16</span></dt>
<dd><p>Ayangleima Laishram, Satya Prakash Sahu, Vineet Padmanabhan, and Siba Kumar Udgata. Collaborative filtering, matrix factorization and population based search: the nexus unveiled. In <em>International Conference on Neural Information Processing</em>, 352–361. Springer, 2016.</p>
</dd>
<dt class="label" id="id5"><span class="brackets">Paz99</span></dt>
<dd><p>Michael J Pazzani. A framework for collaborative, content-based and demographic filtering. <em>Artificial intelligence review</em>, 13(5):393–408, 1999.</p>
</dd>
<dt class="label" id="id8"><span class="brackets">SK09</span></dt>
<dd><p>Xiaoyuan Su and Taghi M Khoshgoftaar. A survey of collaborative filtering techniques. <em>Advances in artificial intelligence</em>, 2009.</p>
</dd>
<dt class="label" id="id7"><span class="brackets">TGB15</span></dt>
<dd><p>Poonam B Thorat, RM Goudar, and Sunita Barve. Survey on collaborative filtering, content-based filtering and hybrid recommendation system. <em>International Journal of Computer Applications</em>, 110(4):31–36, 2015.</p>
</dd>
<dt class="label" id="id18"><span class="brackets">ZYST19</span></dt>
<dd><p>Shuai Zhang, Lina Yao, Aixin Sun, and Yi Tay. Deep learning based recommender system: a survey and new perspectives. <em>ACM Computing Surveys</em>, 52(1):5:1–5:38, Feb 2019. <a class="reference external" href="https://doi.org/10.1145/3285029">doi:10.1145/3285029</a>.</p>
</dd>
</dl>
</p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Sean Cummins<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>